<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MyHbar.io | Hedera Staking Monitor</title>
  <script src="https://unpkg.com/@junobuild/core@latest/dist/index.bundle.js"></script>
<script>
  window.juno.initJuno({ satelliteId: "2s5am-dqaaa-aaaal-asxnq-cai" });
</script>

<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">
<link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --main-color: #00d2d3;
      --main-color-dark: #5a4a7a;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --detail-bg: #161616;
      --text-white: #ffffff;
      --text-gray: #888;
      --danger: #ff5555;
      --success: #4ade80;
      --warning: #fbbf24;
    }

    body {
      margin: 0; padding: 0; font-family: 'Roboto', sans-serif;
      background-color: var(--bg-color); color: var(--text-white);
      display: flex; justify-content: center; min-height: 100vh; overflow-y: auto;
    }

    .container {
      text-align: center; padding: 20px; max-width: 430px; width: 100%; padding-bottom: 50px;
      position: relative; z-index: 1; -webkit-font-smoothing: antialiased;
      transform-origin: top center;
    }

    .screensaver {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #000000;
        z-index: 99999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: none;
        zoom: 1.2;
        -webkit-font-smoothing: antialiased;
        transform-origin: top center;
    }

    .saver-logo {
        font-size: 100px; font-weight: 700; color: var(--main-color);
        margin-bottom: 20px;
        animation: pulseSaver 4s infinite ease-in-out;
    }

    .saver-text {
        font-size: 18px; color: #666; font-family: monospace; letter-spacing: 3px;
        text-transform: uppercase;
        animation: fadeText 10s infinite;
        text-align: center;
        padding: 0 20px;
    }

    @keyframes pulseSaver {
        0% { transform: scale(1); opacity: 0.5; text-shadow: 0 0 0px var(--main-color); }
        50% { transform: scale(1.1); opacity: 1; text-shadow: 0 0 30px var(--main-color); }
        100% { transform: scale(1); opacity: 0.5; text-shadow: 0 0 0px var(--main-color); }
    }

    .welcome-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #000000; 
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 0px;
        -webkit-font-smoothing: antialiased;
        transform-origin: top center;
    }

    .logo-wrapper {
        width: 180px; height: 180px; margin-bottom: 20px;
        border-radius: 50%; overflow: hidden; display: flex; 
        align-items: center; justify-content: center;
        background-color: #000; border: 2px solid #222; padding: 0;
        box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);   
    }

    .welcome-logo {
        width: 100%; height: 100%; object-fit: cover; transform: scale(1.05) translateX(1%); display: block;
    }

    .welcome-title { font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 10px; }
    
    .welcome-text {
        color: #888; font-size: 14px; margin-bottom: 40px; max-width: 300px; line-height: 1.5;
    }

    /* BEGIN UPDATE: Match Pill Button Style */
    .btn-start {
        background: var(--card-bg); color: var(--text-gray); border: 1px solid #333;
        padding: 15px 40px; border-radius: 50px; font-size: 18px; font-weight: bold;
        cursor: pointer; transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    .btn-start:hover { background: #282828; color: var(--text-white); border-color: var(--main-color); transform: scale(1.05); }
    /* END UPDATE */

    .header-row {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 20px; width: 100%;
    }

    .branding { flex: 1; padding: 0 10px; }

    .logo { color: #ffffff; font-size: 30px; font-weight: 700; line-height: 1; }
    .logo span { color: var(--main-color); font-size: 0.75em; cursor: pointer; transition: opacity 0.2s; }
    .logo span:active { opacity: 0.5; }
    
    .tagline { font-size: 14px; font-weight: 500; color: var(--text-gray); letter-spacing: 1px; margin-top: 5px; }

    .icon-btn {
        background: #333; color: #ccc; border: 1px solid #555;
        width: 30px; height: 30px; border-radius: 50%;
        font-size: 14px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s; flex-shrink: 0; 
    }
    .icon-btn:hover { background: #282828; color: white; border-color: var(--main-color); }

    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; padding: 20px;
    }

    .modal {
        background: var(--card-bg); 
        width: 380px;  
        height: 450px; 
        padding: 20px 0px 20px 20px;
        border-radius: 12px; 
        border: 1px solid var(--main-color); 
        text-align: left;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px var(--main-color); 
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden; 
         
        -webkit-font-smoothing: antialiased;
        transform-origin: top center;
    }


  /* ALL MODAL SCROLLBARS */
#hubContentTarget::-webkit-scrollbar, 
#accountingContent::-webkit-scrollbar,
#historyContent::-webkit-scrollbar,
#tpsContentTarget::-webkit-scrollbar,
#specContentTarget::-webkit-scrollbar,
#nodeDetailsTarget::-webkit-scrollbar,
#nodeListModal .modal-body::-webkit-scrollbar {
    width: 12px; /* Widened for easier clicking */
}

/* THE TRACK (Rail) */
#hubContentTarget::-webkit-scrollbar-track, 
#accountingContent::-webkit-scrollbar-track,
#historyContent::-webkit-scrollbar-track,
#tpsContentTarget::-webkit-scrollbar-track,
#specContentTarget::-webkit-scrollbar-track,
#nodeDetailsTarget::-webkit-scrollbar-track,
#nodeListModal .modal-body::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.3);
}

/* THE THUMB (Draggable part) */
#hubContentTarget::-webkit-scrollbar-thumb, 
#accountingContent::-webkit-scrollbar-thumb,
#historyContent::-webkit-scrollbar-thumb,
#tpsContentTarget::-webkit-scrollbar-thumb,
#specContentTarget::-webkit-scrollbar-thumb,
#nodeDetailsTarget::-webkit-scrollbar-thumb,
#nodeListModal .modal-body::-webkit-scrollbar-thumb {
    background: #444;
    border-radius: 4px;
    border: 2px solid transparent; /* Gives it a little 'air' */
    background-clip: content-box;
}

#hubContentTarget::-webkit-scrollbar-thumb:hover, 
#accountingContent::-webkit-scrollbar-thumb:hover,
#historyContent::-webkit-scrollbar-thumb:hover,
#tpsContentTarget::-webkit-scrollbar-thumb:hover,
#specContentTarget::-webkit-scrollbar-thumb:hover,
#nodeDetailsTarget::-webkit-scrollbar-thumb:hover,
#nodeListModal .modal-body::-webkit-scrollbar-thumb:hover {
   
}

/* THE BUTTONS (Clickable Arrows) */
#hubContentTarget::-webkit-scrollbar-button:single-button, 
#accountingContent::-webkit-scrollbar-button:single-button,
#historyContent::-webkit-scrollbar-button:single-button,
#tpsContentTarget::-webkit-scrollbar-button:single-button,
#specContentTarget::-webkit-scrollbar-button:single-button,
#nodeDetailsTarget::-webkit-scrollbar-button:single-button,
#nodeListModal .modal-body::-webkit-scrollbar-button:single-button {
    display: block;
    background-color: #222;
    background-size: 8px;
    background-repeat: no-repeat;
    background-position: center;
    height: 12px;
}

/* UP ARROW ICON */
#hubContentTarget::-webkit-scrollbar-button:single-button:vertical:decrement, 
#accountingContent::-webkit-scrollbar-button:single-button:vertical:decrement,
#historyContent::-webkit-scrollbar-button:single-button:vertical:decrement,
#tpsContentTarget::-webkit-scrollbar-button:single-button:vertical:decrement,
#specContentTarget::-webkit-scrollbar-button:single-button:vertical:decrement,
#nodeDetailsTarget::-webkit-scrollbar-button:single-button:vertical:decrement,
#nodeListModal .modal-body::-webkit-scrollbar-button:single-button:vertical:decrement {
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='grey'><polygon points='50,20 80,80 20,80'/></svg>");
}

/* DOWN ARROW ICON */
#hubContentTarget::-webkit-scrollbar-button:single-button:vertical:increment, 
#accountingContent::-webkit-scrollbar-button:single-button:vertical:increment,
#historyContent::-webkit-scrollbar-button:single-button:vertical:increment,
#tpsContentTarget::-webkit-scrollbar-button:single-button:vertical:increment,
#specContentTarget::-webkit-scrollbar-button:single-button:vertical:increment,
#nodeDetailsTarget::-webkit-scrollbar-button:single-button:vertical:increment,
#nodeListModal .modal-body::-webkit-scrollbar-button:single-button:vertical:increment {
    background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100' fill='grey'><polygon points='20,20 80,20 50,80'/></svg>");
}

    .modal h3 { margin-top: 0; color: var(--text-white);display: flex;
    justify-content: space-between;
    align-items: center;
    margin-right: 20px; }
    .tab-row {
    margin-right: 20px;
}
    .modal p { font-size: 13px; line-height: 1.5; color: #ccc; margin-bottom: 15px; }

    /* BEGIN UPDATE: Match Pill Button Style */
    .close-modal {
        background: #121212; color: var(--text-gray); border: 1px solid #333; width: 100%;
        padding: 10px; border-radius: 50px; cursor: pointer; font-weight: bold; transition: all 0.2s;
    }

  #helpModal .close-modal,
     #accountingModal .close-modal,
     #nodeListModal .close-modal,
     #addressBookModal .close-modal,
     #statusDetailModal .close-modal,
     #specModal .close-modal,
     #nodeModal .close-modal,
     #tpsModal .close-modal {
    width: calc(100% - 20px);
    margin-right: 20px;
}
    .close-modal:hover { background: #282828; color: var(--text-white); border-color: var(--main-color); }
    /* END UPDATE */

    .input-section {
      background-color: var(--card-bg); padding: 15px; border-radius: 8px;
      margin-top: 10px; margin-bottom: 10px; margin-right: 20px; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid #333;
    }
    .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
    input {
      background: #121212; border: 1px solid #444; color: white; padding: 10px;
      border-radius: 6px; font-size: 14px; width: 100%; outline: none;
    }
    input:focus { border-color: var(--main-color); }

    /* BEGIN UPDATE: Match Pill Button Style */
    .btn-add {
      background-color: #121212; color: var(--text-gray); border: 1px solid #333; padding: 10px;
      border-radius: 50px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.2s;
    }
    .btn-add:hover { background: #282828; color: var(--text-white); border-color: var(--main-color); }
    /* END UPDATE */

    .wallet-list { display: flex; flex-direction: column; gap: 10px; width: 100%; }
    .wallet {
      background-color: var(--card-bg); border-radius: 8px; width: 100%;
      text-align: left; overflow: hidden; position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .wallet-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 15px; cursor: pointer;
    }
    .wallet-info { flex: 1; text-align: left; }
    .wallet-nickname { font-size: 16px; font-weight: 500; color: #fff; }
    .wallet-id { font-size: 11px; color: #aaa; margin-top: 2px; font-family: monospace; }
    .wallet-usd { font-size: 16px; font-weight: 700; color: #fff; }
    .btn-delete {
      background: transparent; border: none; color: #444; font-size: 18px;
      cursor: pointer; padding: 0 0 0 10px; margin-left: 5px; z-index: 10;
    }
    .btn-delete:hover { color: var(--danger); }

    .wallet-details {
      max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
      border-top: 1px solid #333; background: #181818;
    }
    .wallet-details.expanded { max-height: 1000px; }
    .wallet-details-content { padding: 0; } 

    .token-row {
      display: flex; justify-content: space-between; padding: 12px 15px; 
      border-bottom: 1px solid #2a2a2a; background: var(--card-bg);
    }
    .token-row:last-child { border-bottom: none; }
    .token-name { font-size: 14px; font-weight: 500; color: #fff; }
    .token-price { font-size: 11px; color: #888; }
    
    .token-amount { text-align: right; }
    
    .token-balance { 
        font-size: 14px; font-weight: 500; color: #fff; 
        cursor: pointer; transition: opacity 0.2s;
    }
    .token-balance:hover { color: #8395a7; }
    
    .token-balance[data-expanded="true"] {
        color: #ffffff; 
    }

    .token-value { font-size: 11px; color: #888; }

    .sub-info {
      background-color: var(--detail-bg); padding: 10px 15px;
      border-bottom: 1px solid #2a2a2a; border-left: 3px solid var(--main-color);
    }
    .info-row {
        display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 5px;
    }
    .info-row:last-child { margin-bottom: 0; }
    
    .info-label { color: #888; }
    .info-label span { color: #555; font-family: monospace; }
    .info-val { color: #ddd; font-weight: 500; }
    .usd-hint { color: #666; margin-left: 4px; font-size: 10px; }

    .totals { margin-top: 20px; font-size: 16px; }
    .totals div { margin: 4px 0; }
    .live-price { margin-top: 15px; font-size: 14px; color: #bbb; padding-top: 5px; }
    
    .status-dot {
      display: inline-block; width: 8px; height: 8px;
      border-radius: 50%; margin-left: 5px; background: #444;
      vertical-align: middle;
    }
    .status-ok { background-color: #5f5; box-shadow: 0 0 5px #5f5; }
    .status-warning { background-color: var(--warning); box-shadow: 0 0 5px var(--warning); }
    .status-error { background-color: #f55; }
    .status-loading { background-color: #fa5; animation: pulse 1s infinite; }

    .system-status {
        margin-top: 15px; padding-top: 10px; border-top: 1px solid #333;
        display: flex; justify-content: center; gap: 15px;
        font-size: 11px; color: #888;
    }
    .status-item { display: flex; align-items: center; gap: 5px; }
    .status-clickable { cursor: pointer; }
    .status-sep { color: #333; font-weight: 300; }

    .button-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
    }

    .button-row {
        display: flex;
        width: 100%;
        gap: 8px;
        justify-content: center;
    }

    .refresh-button {
        background: transparent; 
        color: var(--main-color); 
        border: 1px solid var(--main-color);
        padding: 10px 16px; 
        border-radius: 6px;
        cursor: pointer; 
        font-size: 14px; 
        font-weight: 500; 
        width: 100%;
        transition: all 0.2s;
    }
    
     .screensaver-pill-btn {
        background: var(--card-bg); 
        color: var(--text-gray); 
        border: 1px solid #333;
        padding: 8px 15px;
        border-radius: 50px; 
        font-size: 14px;
        font-weight: 500;
        flex: 1; 
        transition: all 0.2s;
        text-align: center;
    }
    .screensaver-pill-btn:hover { 
        background: #282828; 
        color: var(--text-white); 
        border-color: var(--main-color);
    }

    .refresh-button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* --- NODE MODAL CSS --- */
   .node-trigger { cursor: pointer; color: #fff; font-weight: 500; transition: opacity 0.2s; text-decoration: none; }
    .node-trigger:hover { color: #8395a7; }

    /* BEGIN UPDATE: Shrink Audit Grid height */
    .audit-grid { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; min-height: auto; } 
    /* END UPDATE */

    .audit-card { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 8px; border: 1px solid #2a2a2a; }
    
    .audit-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .audit-label { font-size: 10px; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
    .audit-value { font-size: 13px; color: #eee; font-family: monospace; font-weight: 500; }
    
    .audit-bar-container { width: 100%; height: 6px; background: #1a1a1a; border-radius: 3px; margin: 8px 0; overflow: hidden; }
    .audit-bar-fill { height: 100%; transition: width 0.8s ease-out; }


    /* --- BEGIN UPDATE: Help Accordion & Lock Warning CSS --- */
    .help-section { border-bottom: 1px solid #2a2a2a; }
    .help-header {
        width: 100%; background: transparent; border: none; padding: 15px 5px;
        color: #fff; font-weight: 700; font-size: 14px; text-align: left;
        cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .help-content { display: none; padding: 0 5px 15px 5px; font-size: 13px; color: #ccc; line-height: 1.5; }
    .help-section.active .help-content { display: block; }
    .help-icon-state { font-size: 10px; color: #666; }

    .lock-alert-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 10001; justify-content: center; align-items: center; padding: 20px;
    }
    /* BEGIN UPDATE: Modal Highlight/Glow */
    .lock-alert-box {
        background: var(--card-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--main-color);
        box-shadow: 0 0 20px rgba(107, 91, 149, 0.25); max-width: 320px; text-align: center; -webkit-font-smoothing: antialiased;
      transform-origin: top center;
    }
    /* --- END UPDATE --- */


  #helpModal .modal {
        
        max-height: 70vh;
       -webkit-font-smoothing: antialiased;
      transform-origin: top center;

        
    }


.hub-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 13px; }
  .hub-table td { padding: 10px 4px; border-bottom: 1px solid #2a2a2a; color: #fff; }
  .hub-val { font-family: monospace; font-weight: 500; text-align: right; cursor: pointer; transition: color 0.2s; }
  .hub-val:hover { color: #8395a7; }
  
  
  .grand-total-box { 
      margin-top: 20px; padding: 15px; background: #1a1a1a; 
      border-radius: 8px; border-left: 4px solid var(--success);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
  }
  .combined-label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
  .combined-val { font-family: monospace; font-size: 16px; font-weight: 600; color: var(--success); cursor: pointer; }

/* FISCAL LEDGER STYLES */
  .fiscal-report { background: #151515; border: 1px solid #333; padding: 15px; border-radius: 8px; font-family: monospace; }
  .fiscal-header { font-size: 11px; color: #fff; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
  .fiscal-row { display: flex; justify-content: space-between; padding: 6px 0; font-size: 11px; border-bottom: 1px solid #222; }
  .fiscal-row:last-child { border-bottom: none; }
  .fiscal-label { color: #888; }
  .fiscal-val { color: #fff; font-weight: 500; }
  .fiscal-total-row { background: #1a1a1a; margin-top: 10px; padding: 10px; border-radius: 4px; border-left: 3px solid var(--success); }
  
  .tab-row { display: flex; gap: 5px; margin-bottom: 15px; }
  .tab-btn { flex: 1; background: #222; border: 1px solid #444; color: #888; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
  .tab-btn.active { background: #121212; color: #fff; font-weight: 500; border-color: var(--main-color); }

.header-row {
      display: flex; justify-content: center; align-items: flex-start;
      margin-bottom: 20px; width: 100%;
    }

    .header-nav-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 15px;
    }

.mini-pill {
    flex: 0 0 50px !important;
    font-weight: bold;
    color: var(--main-color);
}

    /* Surgical Update: Restore Hover and pill shape */
    .icon-btn {
        background: var(--card-bg); color: var(--text-gray); border: 1px solid #333;
        width: auto; height: 32px; padding: 0 15px; border-radius: 50px;
        font-size: 14px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s; flex-shrink: 0; 
    }
    .icon-btn:hover { 
        background: #282828; 
        color: var(--text-white); 
        border-color: var(--main-color); 
    }

/* UNIFIED CONTENT TARGETS (Matches all modals) */
#hubContentTarget, 
#accountingContent, 
#historyContent, 
#addressBookList, 
#statusDetailContent,
#tpsContentTarget,
#specContentTarget,
#nodeListModal .modal-body,
#nodeDetailsTarget { 
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 20px; /* This is the 'Gutter' that keeps text away from the bar */
    margin-top: 5px;
}




#nodeListTable { width: 100%; border-collapse: collapse; }
#nodeListTable td { border-bottom: 1px solid #222; vertical-align: middle; padding: 12px 4px; }
.node-id-cell { font-family: monospace; color: var(--main-color); font-weight: bold; width: 30px; font-size: 13px; }
.node-desc-cell { line-height: 1.3; }
.node-reward-cell { text-align: right; color: var(--success); font-family: monospace; font-weight: 500; font-size: 14px; }
.node-host-label { font-size: 14px; font-weight: 450; display: block; color: #fff; }
.node-acc-label { font-size: 11px; color: #666; font-family: monospace; }

.variance-text { font-size: 10px; font-weight: bold; margin-left: 5px; vertical-align: middle; }
  .variance-up { color: var(--success); }
  .variance-down { color: var(--danger); }
  .variance-neutral { color: #666; }

.nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px; /* Space between icon and label */
    }

    .nav-label {
        font-size: 8px; /* Micro-text for a high-end look */
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 700;
    }


/* Custom style for the Hedera Status link */
.status-link {
    text-decoration: none; /* Removes the underline */
    color: inherit;        /* Keeps the text grey like the other items */
    display: flex;
    align-items: center;
    gap: 5px;
    transition: opacity 0.2s;
}

.status-link:hover {
    opacity: 0.7;          /* Gives a subtle "clickable" feel when hovering */
}

/* Prevents the 'visited' purple color */
.status-link:visited, .status-link:active {
    color: inherit;
}

#historyContent .fiscal-row {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* Very subtle line */
}

#historyContent .fiscal-row:last-child {
    border-bottom: none; /* Keeps the bottom clean */
}

 .donation-box { margin-top: 20px; padding-top: 0px; text-align: center; }
    .donation-label { font-size: 12px; color: #666; margin-bottom: 10px; }
    .address-copier {
        background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 8px 12px;
        display: inline-flex; align-items: center; gap: 10px; cursor: pointer;
    }
    .addr-text { font-family: monospace; color: #ddd; font-size: 13px; }
    .copy-icon { color: var(--main-color); font-size: 11px; font-weight: bold; }

.help-content a {
    color: var(--main-color);
    text-decoration: none;
    font-weight: 500;
    transition: opacity 0.2s;
    word-break: break-all; /* Prevents long URLs from breaking the layout */
}

.help-content a:hover {
    opacity: 0.8;
    text-decoration: underline;
}

/* Prevents the default browser 'visited' purple color */
.help-content a:visited, 
.help-content a:active {
    color: var(--main-color);
}

/* Pulse effect for the circle wrapper */
.pulse-circle {
    animation: circleGlow 4s infinite ease-in-out;
    box-shadow: 0 0 20px rgba(107, 91, 149, 0.2); /* Soft initial glow */
}

@keyframes circleGlow {
    0% { transform: scale(1); box-shadow: 0 0 10px var(--main-color); }
    50% { transform: scale(1.05); box-shadow: 0 0 40px var(--main-color); }
    100% { transform: scale(1); box-shadow: 0 0 10px var(--main-color); }
}

/* Tighten screensaver spacing */
.screensaver {
    display: none; /* Hidden by default */
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

#nodeModal { z-index: 3000; }


  </style>
</head>
<body>

<div id="screensaver" class="screensaver" onclick="wakeUp()">
    <!-- Circle Wrapper (Matches Welcome Screen) -->
    <div class="logo-wrapper pulse-circle" style="width: 200px; height: 200px; margin-bottom: 30px; border-color: var(--main-color);">
        <video autoplay muted loop playsinline class="welcome-logo">
            <source src="logo-animation.mp4" type="video/mp4">
        </video>
    </div>
    
    <!-- Status Text (Moved up close to the circle) -->
    <div id="saverMessage" class="saver-text">HELLO FUTURE</div>
</div>

  <div id="welcomeScreen" class="welcome-overlay">
    <div class="logo-wrapper">
        <video autoplay muted loop playsinline class="welcome-logo">
            <source src="logo-animation.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div class="welcome-title">Welcome!<span style="color:var(--main-color); font-size:0.75em;">Ä¦</span></div>
    <p class="welcome-text">
      Your Personal Native & Liquid Staking Monitor
    </p>
<!-- We changed the function to junoSignIn -->
<button class="btn-start" onclick="junoSignIn()">Login with Internet Identity</button>
  </div>

  <!-- BEGIN UPDATE: Warning Modal (Neutralized Text) -->
  <div id="lockAlert" class="lock-alert-overlay">
    <div class="lock-alert-box">
        <h3 style="color:#fff; margin-bottom:15px;">Privacy Lock Active</h3>
        <p style="font-size:13px; color:#ccc; line-height:1.5; margin-bottom:20px;">
            To unlock the dashboard later, you will be required to enter the <strong>Nickname</strong> or <strong>Account ID</strong> of any wallet you have added.
        </p>
        <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:20px; font-size:12px; color:#888;">
            <input type="checkbox" id="hideLockWarning" style="width:16px; height:16px; cursor:pointer;">
            <label for="hideLockWarning" style="cursor:pointer;">Do not display message in future</label>
        </div>
        <button class="close-modal" onclick="confirmLock()">I Understand</button>
    </div>
  </div>
  <!-- END UPDATE -->

  <div id="helpModal" class="modal-overlay">
    <div class="modal">
      <!-- STATIC TABS STAY TOP -->
      <div id="hubTabs" class="tab-row" style="margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;">
          <button class="tab-btn active" onclick="switchHubView('income')">INCOME</button>
          <button class="tab-btn" onclick="switchHubView('summary')">SUMMARY</button>
      </div>
      <!-- SCROLLABLE CONTENT BELOW -->
      <div id="hubContentTarget"></div>
      <button class="close-modal" onclick="toggleHelp()" style="margin-top:20px;">Return to Dashboard</button>
    </div>
</div>

<!-- LEDGER MODAL -->
<div id="accountingModal" class="modal-overlay">
    <div class="modal">
      <h3 style="margin-bottom: 5px;">Earnings Statement</h3>
      <!-- STATIC TABS STAY TOP -->
      <div id="accountingTabs" class="tab-row" style="margin-bottom:15px;">
          <button class="tab-btn active" onclick="toggleAccounting('weekly')">WEEKLY AUDIT</button>
          <button class="tab-btn" onclick="toggleAccounting('periods')">FISCAL PERIODS</button>
          <button class="tab-btn" onclick="toggleAccounting('year')">YEAR TO DATE</button>
      </div>
      <!-- SCROLLABLE CONTENT BELOW -->
      <div id="accountingContent"></div>
      <button class="close-modal" style="font-weight:bold; font-size:14px; margin-top:15px;" onclick="toggleAccounting()">Close Statement</button>
    </div>
</div>

<!-- ACTIVITY HISTORY MODAL -->
<div id="historyModal" class="modal-overlay">
    <div class="modal">
      <h3 style="margin-bottom: 5px;">Activity Ledger (Contributes/Draw)</h3>
      <div id="historyTabs" class="tab-row">
    <!-- tabs[0] -->
    <button class="tab-btn active" onclick="switchHistoryTab('sessions')">SESSIONS</button>
    <!-- tabs[1] -->
    <button class="tab-btn" onclick="switchHistoryTab('rewards')">STAKING</button>
    <!-- tabs[2] -->
    <button class="tab-btn" onclick="switchHistoryTab('activity')">TRANSACTIONS</button>
</div>
      <div id="historyContent" style="flex: 1; overflow-y: auto; padding-right: 5px;">
          <!-- Data populated by JS -->
      </div>
       <div style="display:flex; gap:10px; margin-top:15px; margin-right:20px;">
    <button class="close-modal" style="flex:1; margin-right:0; width:auto;" onclick="toggleHistory()">Close Ledger</button>
    <button class="close-modal" style="width:50px; padding:0; margin-right:0; font-size:18px;" onclick="toggleAddressBook()">ðŸ“‡</button>
</div>
</div>
</div>
   

  <!-- NEW NODE MODAL -->
  <div id="nodeModal" class="modal-overlay">
    <div class="modal" id="nodeModalContent">
      <h3 id="nodeHostName"></h3>
      <p id="nodeFullDesc" style="font-size:11px; margin-bottom:10px; padding-right:20px;"></p>
      <div id="nodeDetailsTarget"></div>
      <button class="close-modal" onclick="closeNodeModal()" style="margin-top:5px;">Close</button>
    </div>
  </div>


<!-- SYSTEM SPECIFICATIONS MODAL -->
<div id="specModal" class="modal-overlay">
    <div class="modal"> <!-- REMOVED 600px height so it matches the 450px others -->
        <h3 style="margin-bottom: 5px;">Dashboard Guide</h3>
        
        <div id="specContentTarget">
            
            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">1. DATA ARCHITECTURE <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                    This is a <strong>Strict Mirror Node</strong> application. It performs real-time REST queries directly to the Hedera Mainnet API. No third-party servers or databases are used, ensuring your data is sourced directly from the ledger.
                </div>
            </div>

            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">2. DATA SOURCES <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                    <p>â€¢ <strong>Token Balances:</strong> <span style="color:var(--success)">Hedera Mirror Node</span> (On-Chain).</p>
               
    <p> â€¢ <strong>HBARX Exchange Rate:</strong> <span style="color:var(--success)">Hedera Mirror Node</span> (Contract).
       <em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">(Since this info is fetched from the contract, mirror node, it may update before Stader's website.)</em></p>
    
      <p>â€¢ <strong>HBAR Price:</strong> <span style="color:var(--success)">Hedera Network</span> (Official Exchange Rate).<br>
      <em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;"> (Uses the **Official Hedera Network Price** for stability. For the volatile market Spot Price, please check your HashPack wallet. **Trend Indicator (â–²/â–¼)** shows the last direction the price moved).</em></p>

    <p> â€¢ <strong>HBARX Price:</strong> Calculated as (HBAR Price) Ã— (Exchange Rate).<br>
      <em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">(This represents the underlying HBAR value of the token).</em></p>
      
<p>â€¢ <strong>USDC Price:</strong> Calculated at standard <strong>$1.00 Peg</strong>.</p>

<p>â€¢ <strong>Network TPS:</strong> <strong>TAP</strong> "TPS" opens a live block audit, analyzing the transaction volume of the previous 25 blocks on the network.
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">
    Calculated every 5 seconds by analyzing the transaction count of the most recent block. Provides a <strong>"Burst TPS"</strong> snapshot, showing how busy the network is at this specific moment.</em></p>

<p>â€¢ <strong>Hedera Status:</strong> <strong>TAP</strong> Hedera to access status info.
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">
    A dual-check system. Monitors the official Status API and performs a <strong>"Block Age"</strong> check. If a block was produced in the last 12 seconds, the network is verified as <strong>"Alive."</strong> 
</em></p>
   
 <p>â€¢ <strong>Node Info:</strong> <strong>TAP</strong> any 'Staked to Node #' or node in the list to view information about that node. (Host, Capacity, and Health).
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">
        â€¢ <strong>Stake for Consensus:</strong> The total voting weight of the node. High weight (near 450M) creates network stability.<br>
        â€¢ <strong>Staked for Reward:</strong> This is the paid portion of the stake.<br>
        <strong>The Secret:</strong> If this number exceeds the 'Max Reward Cap' (usually 450M), the reward bucket is split between too many coins and your APY drops.</em></p>

                </div>
            </div>

            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">3. PRECISION & TOGGLE UI <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                   <p> Almost every number is interactive. Clicking a value toggles between 3 or 4 decimals to 8 decimals for precision. The system uses <em>State-Persistence</em> to remember your preference for every field.</p>
<p>â€¢ <strong>Live Price Toggle:</strong> <em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Tap the displayed price at the bottom to toggle between the **HBAR Network Price** and the **HBARX Calculated**.</em></p>
<p>â€¢ <strong>Total Toggle:</strong><em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;"> Tap Total or Total USD at the bottom to toggle between the Total Hbar (+HBARX Equiv) and Total USD of all Wallets.</em></p>

                </div>
            </div>

            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">4. LIQUID & NATIVE STAKING  <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
               <p><strong>Native:</strong> Captures a 00:00 UTC baseline of pending rewards to calculate live "Today's Accrued" earnings, with the Hedera 24h reward cycle. Accruals reset when the timer hits zero.<br>
               â€¢ <strong>Claiming Pending Rewards</strong><em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">
                The dashboard is designed to keep your green accrued number even after removing your "pending" rewards. This is so you can see how much you earn every day. Even as you stack your pending rewards, the reset helps you know exactly what you earn daily.</em></p>

 <p><strong>HBARX Equivalent (Unstake Value)</strong><br>
     <p>This dashboard focuses on your <strong>HBARX Equivalent,</strong> the total amount of HBAR you actually own inside the staking pot.<br>
       <span style="font-size: 0.9em; color: #888; display:block; margin-top:5px;">
      â€¢ <strong>Unstake Value:</strong> This shows what your assets are worth if you were to unstake on Stader. 
      </span>
      </p>
   
     <p> Tracks the <strong>Exchange Rate Update</strong> from the Stader Contract to show how much HBAR you earned <strong>since the dashboard was last reset (Midnight UTC).</strong> Provides a continuous record of your staking rewards accrual.<br>
      <span style="font-size: 0.9em; color: #888; display:block; margin-top:5px;">
      â€¢ <strong>Reset:</strong> Counters reset to 0 every day at Midnight UTC.<br>
      â€¢ <strong>Daily Total:</strong> The final "Grand Total" of yield verified and "locked in" during the most recent turnover sync.<br>      
      â€¢ <strong>Baseline Reset:</strong> This status ('New Wallet' or 'Balance Change') appears for the first 24 hours after a wallet is added or its HBARX balance changes by 1.0 or more (deposit/withdraw). This suppresses the 'Green Number' to prevent reporting inaccurate, inflated earnings.<br>
      â€¢ <strong>Pending:</strong> "Pending Daily Reward..." means the new day has started, and we are <strong>waiting</strong> for the network to send the update.<br>  
      â€¢ <strong>Green Number:</strong> Shows your total growth since last exchange rate update.  </span></p>
       
<p><strong>Next Reward Timer</strong><br>
        The timer counts down to the Hedera Epoch Turnover (Midnight UTC). This is when the dashboard resets for the new day.  
<em style="font-size: 1.0em; color: #888; display:block; margin-top:5px;">
        </em>
      </p>
            </div>
           </div>

            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">5. INCOME & SUMMARY <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                   <p>Accessible via the <strong>Income (ðŸ’°)</strong> icon, this modal partitions your data into two distinct professional views:</p>
                  <p>â€¢ <strong>Income Tab (Projected):</strong> A forward-looking earnings calculator.
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Calculates your daily and monthly projections based on current live APYs. It tracks your "True HBAR" (Wallet) vs. "HBARX Equiv" (Stader) and shows your combined daily revenue.</em></p>

<p>â€¢ <strong>Summary Tab (Asset Audit):</strong> A snapshot of your current net-worth.
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Shows every individual wallet and their split between HBAR, HBARX, and USDC.</em></p>

<p>â€¢ <strong>Trend Analysis:</strong> Look for the (â–²/â–¼) icons. 
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">These icons compare your current stats to your most recent <strong>Fiscal Entry</strong>, showing whether your balances or daily earnings are increasing or decreasing over time.</em></p>

                </div>
            </div>

           <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">6. ACTIVITY (CONTRIBUTES/DRAW) <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                   <p>Accessible via the <strong>Activity (â‡„)</strong> icon, this performs a "Consolidated Entity Audit" of every transaction occurring this month.</p>
 <p>â€¢ <strong>The "Internal" Rule:</strong>
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Transfers between your own added wallets (e.g., VAULT âž” WALLET) are identified as <strong>Internal</strong>. They are logged for history but <strong>Eliminated</strong> from your TOTALS at the top. This ensures your audit totals reflect true wealth growth, not just money you moved between pockets.</em></p>

<p>â€¢ <strong>Contributions (Inflow):</strong>
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Any asset entering your ecosystem from an external source (Exchanges, Rewards, or friends).</em></p>

<p>â€¢ <strong>Draws (Outflow):</strong>
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Any asset leaving your ecosystem to an external address. Network fees are surgically separated and tracked as an expense.</em></p>

<p>â€¢ <strong>Reward Capture (+REW):</strong>
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Even inside an internal transfer, the dashboard extracts the staking reward. You will see <strong>+REW</strong> in the label, and that specific reward amount will be added to your "staking" tab.</em></p>
                </div>
            </div>

            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">7. LEDGER (EARNINGS STATMENT) <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                   <p>Accessible via the <strong>Ledger (ðŸ“’)</strong> icon, this is your official "Paystub" for the Hedera network. It utilizes historical snapshots saved locally on your device.</p> 
                  <p>â€¢ <strong>Weekly Audit:</strong> Granular daily tracking.
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Shows your total earnings for the last 7 days. It includes a <strong>Weekly Variance</strong> percentage, comparing your performance to the previous week.</em></p>

<p>â€¢ <strong>Fiscal Periods (28-Day):</strong> Professional accounting standard.
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Unlike calendar months (30/31 days), we group data into 28-day blocks. This provides four perfect 7-day weeks, creating a "Level Playing Field" for comparing growth trends without the noise of variable month lengths.</em></p>

<p>â€¢ <strong>Year to Date (YTD):</strong> Segmented Revenue analysis.
<em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Breaks down your total annual profit into <strong>Native Staking</strong> and <strong>Liquid Staking</strong> segments. It also calculates your <strong>Average Daily Revenue</strong> for the entire year. Keeps track to up to 5 years before starting over.</em></p>

                </div>
            </div>

                          

            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">8. AMBIENT & PRIVACY MODE <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                     <p><strong>Activation:</strong> TAP 'Ambient Mode' or wait for 20 minutes of inactivity. TAP the lock to lock/unlock 'Privacy Mode.'</p>
            <p>â€¢ <strong>Privacy Locked Mode:</strong><em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;"> Displays Logo, TPS, and live HBAR prices.</em></p>
            <p>â€¢ <strong>Privacy Unlocked Mode:</strong><em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;"> Cycles through Wallet Totals, HBAR Totals, USD Totals, Accrued Earnings, and Grand Daily totals.</em></p>
            <p>â€¢ <strong>Privacy Mode:</strong><em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;"> Locks and hides all personal information. Even clickable buttons for earnings and wallet history.</em></p>
                                                                                                                                                  
                </div>
            </div>

            <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">9. THEME & CUSTOMIZATION <span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                     <p>You can personalize the dashboard theme color:<br>
        <span style="font-size: 0.9em; color: #888; display:block; margin-top:5px;">
        â€¢ <strong>Lock Color:</strong> Tap the <strong style="color:var(--main-color)">.io</strong> in the top logo. <br>
        &nbsp;&nbsp;- If Random: Locks the CURRENT color.<br>
        &nbsp;&nbsp;- If Locked: Cycles to NEXT color.<br>
        â€¢ <strong>Reset Random:</strong> Tap <strong>Dashboard Status</strong> at the bottom.</p></span>
      <p> â€¢ <strong>Auto-Sorting:</strong><em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;"> Every time data is refreshed, your wallets are automatically re-organized by balance. Lower-value accounts sit at the top, while high-value vaults move to the bottom to anchor your portfolio totals.<br> </em></p>
        <p>â€¢ <strong>System Heartbeat:</strong> <em style="font-size: 0.9em; color: #888; display:block; margin-bottom:2px;">Logic and theme colors refresh on an independent 60s loop. This "staggered" timing ensures Mirror Node stability and captures fresh network pricing shortly after the global Epoch turnover (Midnight UTC).</em></p>
       </p>
                </div>
            </div>

                <div class="help-section">
                <div class="help-header" onclick="toggleHelpSection(this)">10. OPEN-SOURCE CODE<span class="help-icon-state">â–¼</span></div>
                <div class="help-content">
                  <a href="https://github.com/ajtringa/myhbar-dashboard" target="_blank">https://github.com/ajtringa/myhbar-dashboard</a>
                    
                </div>
            </div>

        </div>

        <button class="close-modal" onclick="toggleSpec()" style="margin-top:20px;">Return to Dashboard</button>
    </div>
</div>

  <!-- ADD WALLET MODAL -->
  <div id="addWalletModal" class="modal-overlay">
    <div class="modal">
        <h3>Add New Wallet</h3>
        <p>Monitor native rewards and HBARX growth by entering an account ID.</p>
        <div class="input-section">
            <div class="input-row">
              <input type="text" id="newId" placeholder="Account ID (0.0.xxxx)">
              <input type="text" id="newNick" placeholder="Name" style="width: 40%">
            </div>
            <button class="btn-add" onclick="addWallet()">Add Wallet</button>
        </div>
        <button class="close-modal" onclick="toggleAddWalletModal()" style="margin-top:5px;">Cancel</button>
    </div>
  </div>

<div id="nodeListModal" class="modal-overlay">
    <div class="modal">
        <h3 style="margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
            Network Nodes
            <span id="nodeCountBadge" style="font-size: 11px; background: var(--main-color); color: #000; padding: 2px 8px; border-radius: 12px;">...</span>
        </h3>
        <!-- THE WRAPPER FOR SCROLLING -->
        <div class="modal-body">
            <table class="hub-table" id="nodeListTable">
                <thead>
                    <tr style="font-size: 11px; color: #888; text-transform: uppercase;">
                        <th style="text-align: left; padding-bottom: 10px;">ID</th>
                        <th style="text-align: left; padding-bottom: 10px;">Node / Host</th>
                        <th style="text-align: right; padding-bottom: 10px;">APY</th>
                    </tr>
                </thead>
                <tbody id="nodeListBody"></tbody>
            </table>
        </div>
        <button class="close-modal" onclick="toggleNodeListModal()" style="margin-top:20px;">Close Window</button>
    </div>
</div>

<!-- TPS PERFORMANCE MODAL -->
<div id="tpsModal" class="modal-overlay">
    <div class="modal">
        <h3>Network Throughput</h3>
        <!-- STATIC HEADER (Stays Put) -->
        <div id="tpsHeader" style="margin-right:20px; margin-bottom:10px;"></div>
        
        <!-- SCROLLABLE CONTENT (Moves) -->
        <div id="tpsContentTarget">
            <p style="color:#666; font-size:11px;">Analyzing recent blocks...</p>
        </div>
        <button class="close-modal" onclick="toggleTpsModal()" style="margin-top:20px;">Close Audit</button>
    </div>
</div>

<!-- SYSTEM STATUS MODAL -->
<div id="statusDetailModal" class="modal-overlay">
    <div class="modal">
        <h3 id="statusDetailTitle">Hedera Network Status</h3>
        <div id="statusDetailContent" style="flex: 1; overflow-y: auto; padding-right: 10px;">
            <p style="color:#666; font-size:11px;">Fetching official network advisories...</p>
        </div>
        <button class="close-modal" onclick="toggleStatusDetailModal()" style="margin-top:20px;">Close Status</button>
    </div>
</div>

<div id="addressBookModal" class="modal-overlay">
    <div class="modal">
        <h3 style="margin-bottom: 5px;">Address Book</h3>
        <p style="font-size:11px; color:#666; margin-bottom:15px;">Label external addresses like Exchanges or DEXs.</p>
        <div id="addressBookList" style="flex: 1; overflow-y: auto; margin-bottom: 10px; border-bottom:1px solid #222;">
            <!-- Contacts show here -->
        </div>
        <div class="input-section" style="margin-top:0; background:transparent; border:none; padding:0;">
            <div class="input-row">
                <input type="text" id="contactId" placeholder="0.0.xxxx">
                <input type="text" id="contactName" placeholder="Name (e.g. Coinbase)" style="width:40%">
            </div>
            <button class="btn-add" onclick="addContact()">Add Contact</button>
        </div>
        <button class="close-modal" onclick="toggleAddressBook()" style="margin-top:10px;">Return</button>
    </div>
  </div>

  <div class="container">
    
    <div class="header-row" style="justify-content: center;">
        <div class="branding">
            <div class="logo">MyHbar<span onclick="cycleColor()">.io</span></div>
            <div class="tagline">Your Personal Native & Liquid Staking Monitor</div>
            <div class="tagline" style="color:var(--main-color); font-weight:700; font-size:11px; margin-top:2px; letter-spacing:0.5px;">
                RETAIL PAYS THE BILLS â€¢ ENTERPRISE CREATES STABILITY â€¢ INSTITUTIONAL GRADE
            </div>
            <div class="tagline">HBAR / HBARX / USDC</div>

         <div class="header-nav-row">
        <!-- PRIVACY -->
        <div class="nav-item">
            <button class="icon-btn" id="eyeBtn" onclick="togglePrivacy()">ðŸ”“</button>
            <div class="nav-label">Privacy</div>
        </div>

        <!-- EARNINGS -->
        <div class="nav-item">
            <button class="icon-btn" onclick="toggleHelp()" style="font-size: 16px;">ðŸ’°</button>
            <div class="nav-label">Income</div>
        </div>

        <!-- History -->
   <div class="nav-item">
    <button class="icon-btn" onclick="toggleHistory()" style="font-size: 16px;">â‡„</button>
    <div class="nav-label">Activity</div>
</div>
   
 <!-- LEDGER -->
        <div class="nav-item">
            <button class="icon-btn" onclick="toggleAccounting()" style="font-size: 16px;">ðŸ“’</button>
            <div class="nav-label">Ledger</div>
        </div>

        <!-- NODES -->
        <div class="nav-item">
            <button class="icon-btn" onclick="toggleNodeListModal()" style="font-size: 16px;">ðŸŒ</button>
            <div class="nav-label">Nodes</div>
        </div>
  </div>
  


    <!-- DATA LIST (TOP) -->
    <div class="wallet-list" id="walletList"></div>

    <div class="totals">
      <div id="totalHbar">Total HBAR: 0</div>
      
      <div class="live-price" title="Click to toggle between HBAR and HBARX price.">
        <span id="priceLabel">HBAR Price (Network):</span> 
        <span id="toggledPrice" onclick="togglePrice()" style="cursor:pointer;">$0.00</span> 
      </div>
      
      <div style="font-size:11px; color:#888; margin-top:10px"> 
        Official HBARX Exchange Rate: <span id="staderGlobal">...</span>
      </div>

      <div style="font-size:11px; color:var(--main-color); margin-top:4px; font-weight:500;">
        Next Reward: <span id="epochTimer">Loading...</span>
      </div>

      <div class="system-status">
          <div class="status-item status-clickable" onclick="resetColor()" title="Click to reset Random Color">
            <span class="status-dot" id="netStatus" style="margin-right: 5px;"></span>Dashboard
        </div>
          <span class="status-sep">|</span>
          <div class="status-item" style="cursor:pointer;" onclick="toggleTpsModal()" title="Click for Block Audit">
    TPS: <span id="liveTps" style="color:#ccc; font-weight:700; display: inline-block; min-width: 15px;">...</span>
</div>
          <span class="status-sep">|</span>
          <div class="status-link" style="cursor:pointer;" onclick="toggleStatusDetailModal()">
    Hedera<span class="status-dot" id="mainnetHealth"></span>
</div>
    </div>

   <div class="button-group">
        <button class="refresh-button" id="refreshButton" onclick="render()">Refresh Now</button>
        <div class="button-row">
            <button class="screensaver-pill-btn" onclick="startScreensaver()">Ambient</button>
            <button class="screensaver-pill-btn mini-pill" onclick="toggleSpec()" title="">?</button>
            <button class="screensaver-pill-btn" onclick="toggleAddWalletModal()">Add Wallet</button>
        </div>
    </div>
   
    <span style="display:inline-block; font-size: 10px; color: #888;">Ä¦edera Onlyfan â€¢ Ä§bar Addict â€¢ #graph Gossiper â€¢ HBARx Rated â€¢ All In the Hash</span>
      </div>
     </div>
  </div>

<button id="logoutBtn" class="screensaver-pill-btn" style="display:none; margin-top:10px; border-color:red;" onclick="junoSignOut()">Logout</button>
    <div class="donation-box">
      <div class="donation-label" style="font-size: 12px; color: #666; margin-bottom: 10px;">
        Free tool for the community. Created by ajt.hbar.<br>
        <span style="display:inline-block; margin-top: 4px; color: #888;">Support the dev:</span>
      </div>
      <div class="address-copier" onclick="copyAddress()">
        <span class="addr-text">0.0.8889863</span> 
        <span class="copy-icon">COPY</span>
      </div>
      <div id="copyMsg" style="color: #4ade80; height: 15px; margin-top: 5px; opacity: 0; transition: opacity 0.5s; font-size: 11px;">
        Address Copied!
      </div>
    </div>
  </div>

<script>


    const STORAGE_KEY = "public_hedera_monitor_wallets";
    const colors = [
        // --- The Professional Greys/Whites ---
        '#ffffff', // Pure White (Super clean)
        '#dcdde1', // Light Grey
        '#8395a7', // The Blue-Grey from your screenshot
        
        // --- Hedera & Finance Vibes ---
        '#6b5b95', // Your original Amethyst
        '#a55eea', // Modern Purple
        '#54a0ff', // Trust Blue
        '#00d2d3', // Cyan Tech
        
        // --- Staking & Success Greens ---
        '#1dd1a1', // Vibrant Mint
        '#10ac84', // Deep Teal
        '#32cd32', // Lime (Goes well with "Earnings")
        '#39ff14',
        
        // --- Gold/Warning Accents ---
        '#feca57', // HBAR Gold
        '#ff9f43', // Soft Orange
        
        // --- Soft Pastels (Good contrast) ---
        '#ff6b6b', // Soft Red
        '#ff9ff3', // Pinkish
        '#c8d6e5',  // Ice Blue

        // --- VIBRANT NEONS (The "Pop" colors) ---
        '#00ff88', // Electric Seafoam (Vibrant Green)
        '#adff2f', // Volt (Yellow-Green)
        '#ff0055', // Electric Cherry (Vibrant Red)
        '#ff3e3e', // Vivid Crimson
        '#00ccff', // Cyber Blue
        '#ff00ff', // Hot Pink
        '#fff200', // Nuclear Yellow
        '#7000ff' // Electric Purple
    ];
    
    const state = {
        totalDisplayMode: localStorage.getItem('myhbar_total_pref') || 'HBAR',
        hubSectionsOpen: new Set(),
        historySectionsOpen: new Set(),
        wallets: [],
        nodes: [],
        hubView: 'income',
        prices: { 
            HBAR: 0, 
            USDC: 1.00,
            NETWORK_HBAR: 0, 
        },
        staderRate: 1.35,
        lastUpdateTime: null,
        yesterdayDiff: 0,
        isRefreshing: false,
        privacyMode: false,
        previousRate: 1.35,
        expandedKeys: new Set(),
        openTabs: new Set(), 
        priceToggleMode: 'HBAR',
        totalDisplayMode: 'EQUIV', 
        oldHbarPrice: 0,
        oldHbarxUsdPrice: 0,
        stickyHbarArrow: '',
        stickyHbarxArrow: '',
        lastTotalHbar: "0",
        lastTotalUsd: "$0.00",
        lastAccrued: "0",
        lastGrandDaily: "0",
        currentNativeRate: 0.02481,
        hubExpandedKeys: new Set(),
        accountingLedger: JSON.parse(localStorage.getItem('hbar_fiscal_ledger') || '[]'),
        fiscalArchives: JSON.parse(localStorage.getItem('hbar_fiscal_archives') || '[]'),
        accountingView: 'weekly',
        addressBook: JSON.parse(localStorage.getItem('myhbar_address_book') || '[]'),
        tpsInterval: null,
        peakTps: 0,
        historyView: 'sessions',
        historyData: [] 
    };
    
    function startEpochTimer() {
        function update() {
            const now = new Date();
            const nextEpoch = new Date(now);
            nextEpoch.setUTCHours(24, 0, 0, 0); 
            const diff = nextEpoch - now;
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            const hStr = h < 10 ? "0" + h : h;
            const mStr = m < 10 ? "0" + m : m;
            const sStr = s < 10 ? "0" + s : s;
            const el = document.getElementById('epochTimer');
            if(el) el.innerText = `${hStr}h ${mStr}m ${sStr}s`;
        }
        update(); setInterval(update, 1000);
    }

function getIndicator(current, previous) {
    if (!previous || previous === 0) return ''; 
    if (current > (previous + 0.0000001)) return '<span style="color:var(--success)"> â–²</span>';
    if (current < (previous - 0.0000001)) return '<span style="color:var(--danger)"> â–¼</span>';
    return '<span style="color:#888;"> â€”</span>';
}

    let idleTime = 0;
    const idleLimit = 20; 
    let saverInterval;
    let textCycleInterval;
    let ignoreReset = false;

    document.onmousemove = resetTimer;
    document.onkeypress = resetTimer;
    document.ontouchstart = resetTimer;
    document.onclick = resetTimer;

   function wakeUp() { resetTimer(); }

   function resetTimer() {
         if (ignoreReset) { ignoreReset = false; return; } 
        idleTime = 0;
        const saver = document.getElementById('screensaver');
        if (saver.style.display === 'flex') {
            saver.style.display = 'none'; 
            clearInterval(textCycleInterval); 
            document.body.style.overflowY = 'auto';
        }
    } 

    setInterval(() => {
        idleTime++;
        if (idleTime >= idleLimit) startScreensaver();
    }, 60000);

    function startScreensaver() {
        ignoreReset = true;
        const saver = document.getElementById('screensaver');
        if (saver.style.display !== 'flex') {
            saver.style.display = 'flex';
            document.body.style.overflowY = 'hidden'; 
            cycleSaverText(); 
            textCycleInterval = setInterval(cycleSaverText, 8000); 
        }
    }

   let saverStep = 0;
    function cycleSaverText() {
        const el = document.getElementById('saverMessage');
        const price = state.prices.NETWORK_HBAR > 0 ? state.prices.NETWORK_HBAR : state.prices.HBAR;
        
        let steps = [];
        // If Privacy is ON (Locked), we only show network info
        if (state.privacyMode) {
            steps = [
                "HELLO FUTURE",
                "HEDERA HASHGRAPH",
                `${document.getElementById('liveTps').innerText} TPS`,
                `HBAR Price: $${price.toFixed(4)}`,
      "RETAIL PAYS THE BILLS",
      " ENTERPRISE CREATES STABILITY ",
      " INSTITUTIONAL GRADE"
            ];
        } else {
            // If Privacy is OFF (Unlocked), we show your personal stats
            steps = [
                "HELLO FUTURE",
                "HEDERA HASHGRAPH",
                `${document.getElementById('liveTps').innerText} TPS`,
                "RETAIL PAYS THE BILLS",
                `HBAR Price: $${price.toFixed(4)}`,
                `Total HBAR: ${state.lastTotalHbar} â„`,
                " ENTERPRISE CREATES STABILITY ",
               `Total USD: $${state.lastTotalUsd}`,
                `Accrued: +${state.lastAccrued} â„`,
       " INSTITUTIONAL GRADE",
      `Prev. Daily Earnings: +${state.lastGrandDaily} â„` 
       
            ];
        }

        saverStep = (saverStep + 1) % steps.length;
        el.innerText = steps[saverStep];

        // Style the text based on content
        if (el.innerText.includes("â„") || el.innerText.includes("$")) {
            el.style.color = "#888" ; // Green for money stats
            el.style.fontFamily = "monospace";
        } else {
            el.style.color = "#888"; 
            el.style.fontFamily = "'Roboto', sans-serif";
        }
    }
    function togglePrice() {
        state.priceToggleMode = (state.priceToggleMode === 'HBAR') ? 'HBARX' : 'HBAR';
        render(true);
    }

    function toggleTotalDisplay() {
    state.totalDisplayMode = (state.totalDisplayMode === 'HBAR') ? 'USD' : 'HBAR';
    localStorage.setItem('myhbar_total_pref', state.totalDisplayMode);
    render(true);
}
    

    function updatePriceDisplay() {
        const hbarxUsdPrice = state.staderRate * state.prices.HBAR;
        const hbarArrow = getIndicator(state.prices.HBAR, state.oldHbarPrice);
        const hbarxArrow = getIndicator(hbarxUsdPrice, state.oldHbarxUsdPrice);
        if (hbarArrow.includes('â–²') || hbarArrow.includes('â–¼')) state.stickyHbarArrow = hbarArrow;
        if (hbarxArrow.includes('â–²') || hbarxArrow.includes('â–¼')) state.stickyHbarxArrow = hbarxArrow;
        let priceToDisplay, labelToDisplay, finalArrowToUse;
        if (state.priceToggleMode === 'HBAR') {
            priceToDisplay = state.prices.HBAR; labelToDisplay = 'HBAR Price (Network):'; finalArrowToUse = state.stickyHbarArrow;
        } else { 
            priceToDisplay = hbarxUsdPrice; labelToDisplay = 'HBARX Price (Calculated):'; finalArrowToUse = state.stickyHbarxArrow;
        }
        setElementText('priceLabel', labelToDisplay);
        setElementHTML('toggledPrice', `$${priceToDisplay.toFixed(4)}${finalArrowToUse}`);
    }

  async function showNodeAudit(nodeId) {
        const overlay = document.getElementById('nodeModal');
        const contentEl = document.getElementById('nodeDetailsTarget');
        const hostTitle = document.getElementById('nodeHostName');
        const hostDesc = document.getElementById('nodeFullDesc');

        try {
            const res = await fetch(`https://mainnet-public.mirrornode.hedera.com/api/v1/network/nodes?node.id=${nodeId}`);
            const data = await res.json();
            const n = data.nodes[0];

            const max = Number(n.max_stake) / 100000000;
            const consensus = Number(n.stake) / 100000000;
            const rewarded = Number(n.stake_rewarded) / 100000000;
            const notRewarded = Number(n.stake_not_rewarded) / 100000000;
            const rewardRate = n.reward_rate_start / 100000000;

            const yearlyApy = (rewardRate * 365 * 100).toFixed(3);
            const consensusPerc = Math.min((consensus / max) * 100, 100).toFixed(1);
            const rewardPerc = Math.min((rewarded / max) * 100, 100).toFixed(1);

            hostTitle.innerText = "Node " + nodeId;
            hostDesc.innerText = n.description;
            contentEl.innerHTML = `
                <div class="audit-grid">
                    <div class="audit-card">
                        <div class="audit-row"><span class="audit-label">Validator Status</span><span class="audit-value" style="color:var(--success)">ACTIVE</span></div>
                        <div class="audit-row"><span class="audit-label">Current APY</span><span class="audit-value" style="color:var(--success); font-size:16px;">${yearlyApy}%</span></div>
                        <div class="audit-row"><span class="audit-label">Account</span><span class="audit-value">${n.node_account_id}</span></div>
                    </div>
                    <div class="audit-card">
                        <div class="audit-row"><span class="audit-label">Stake for Consensus</span><span class="audit-value">${Math.round(consensus).toLocaleString()} â„</span></div>
                        <div class="audit-bar-container">
                            <div class="audit-bar-fill" style="width: ${consensusPerc}%; background: #444;"></div>
                        </div>
                        <div class="audit-row"><span class="audit-label" style="font-size:8px;">Network Weight</span><span class="audit-value" style="font-size:10px; color:#888;">${consensusPerc}% of Cap</span></div>
                    </div>
                    <div class="audit-card">
                        <div class="audit-row"><span class="audit-label">Staked for Reward</span><span class="audit-value" style="color:var(--success)">${Math.round(rewarded).toLocaleString()} â„</span></div>
                        <div class="audit-bar-container">
                            <div class="audit-bar-fill" style="width: ${rewardPerc}%; background: var(--success);"></div>
                        </div>
                        <div class="audit-row">
                            <span class="audit-label">Not Rewarded</span>
                            <span class="audit-value" style="color:#888;">${Math.round(notRewarded).toLocaleString()} â„</span>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; padding: 0 5px; opacity:0.6;">
                        <div class="audit-row" style="flex-direction:column; align-items:flex-start;">
                            <span class="audit-label">Min Threshold</span>
                            <span class="audit-value" style="font-size:10px;">0 â„</span>
                        </div>
                        <div class="audit-row" style="flex-direction:column; align-items:flex-end;">
                            <span class="audit-label">Max Reward Cap</span>
                            <span class="audit-value" style="font-size:10px;">${Math.round(max).toLocaleString()} â„</span>
                        </div>
                    </div>
                </div>
            `;
            
           
            overlay.style.display = 'flex';

        } catch (e) { 
            console.error("Audit Failed", e);
            alert("Node data currently unavailable.");
        }
    }
 function closeNodeModal() { document.getElementById('nodeModal').style.display = 'none'; }

    function toggleDetails(id) { 
        const detailsId = id.toString();
        const el = document.getElementById(`details-${detailsId}`);
        if(!el) return;
        el.classList.toggle('expanded'); 
        if (el.classList.contains('expanded')) state.openTabs.add(detailsId);
        else state.openTabs.delete(detailsId);
    }


function toggleTpsModal() {
    const modal = document.getElementById('tpsModal');
    const isOpen = modal.style.display === 'flex';
    
    if (!isOpen) {
        modal.style.display = 'flex';
        fetchTpsDetails(); // Load immediately
        // SURGICAL ADDITION: Start the 5-second heartbeat
        state.tpsInterval = setInterval(fetchTpsDetails, 5000); 
    } else {
        modal.style.display = 'none';
        // SURGICAL ADDITION: Kill the timer when closed
        clearInterval(state.tpsInterval);
    }
}

async function fetchTpsDetails() {
    const target = document.getElementById('tpsContentTarget');
    try {
        const res = await fetch('https://mainnet-public.mirrornode.hedera.com/api/v1/blocks?limit=25');
        const data = await res.json();
        
        let totalTx = 0;
        let totalTime = 0;
        let rowsHtml = "";
        let maxInBlock = 0;

        data.blocks.forEach((b, i) => {
            const count = b.count;
            if (count > maxInBlock) maxInBlock = count;
            const duration = parseFloat(b.timestamp.to) - parseFloat(b.timestamp.from);
            totalTx += count;
            totalTime += duration;

            // Simple CSS bar chart to show "fullness" of the block
            const barWidth = Math.max((count / 1000) * 100, 2); // Assume 1000 is a "busy" block

            rowsHtml += `<tr>
                <td style="color:#555; font-size:10px; font-family:monospace;">#${b.number}</td>
                <td style="padding: 10px 0;">
                    <div style="height:4px; background:rgba(255,255,255,0.05); border-radius:2px; width:80px; overflow:hidden;">
                        <div style="height:100%; background:var(--main-color); width:${barWidth}%;"></div>
                    </div>
                </td>
                <td style="text-align:right; font-family:monospace; font-weight:bold;">${count} <span style="font-size:8px; color:#555;">TX</span></td>
            </tr>`;
        });

        const avgTps = Math.round(totalTx / (totalTime || 1));
        if (avgTps > state.peakTps) state.peakTps = avgTps;

        // 1. Update the FIXED HEADER
        document.getElementById('tpsHeader').innerHTML = `
            <div style="padding: 15px; background: rgba(255,255,255,0.02); border-radius: 8px; border-left: 4px solid var(--main-color); border-bottom: 1px solid #333;">
                <div style="display:flex; justify-content:space-between;">
                    <div>
                        <div style="font-size:10px; color:#888; text-transform:uppercase; letter-spacing:1px;">Average (Last 25)</div>
                        <div style="font-size:24px; font-weight:bold; color:#fff; margin-top:5px;">${avgTps.toLocaleString()} <span style="font-size:14px; color:var(--main-color);">TPS</span></div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:10px; color:#888; text-transform:uppercase; letter-spacing:1px;">Session Peak</div>
                        <div style="font-size:24px; font-weight:bold; color:var(--success); margin-top:5px;">${state.peakTps.toLocaleString()}</div>
                    </div>
                </div>
            </div>`;

        // 2. Update the SCROLLABLE CONTENT
        document.getElementById('tpsContentTarget').innerHTML = `
            <div class="fiscal-header">Recent Block Archive</div>
            <table class="hub-table" style="font-size:12px;">
                ${rowsHtml}
            </table>`;
      
    } catch (e) {
        target.innerHTML = `<p style="color:var(--danger);">Failed to query block history.</p>`;
    }
}

    function toggleStatusDetailModal() {
    const modal = document.getElementById('statusDetailModal');
    const isOpen = modal.style.display === 'flex';
    modal.style.display = isOpen ? 'none' : 'flex';
    if (!isOpen) fetchStatusDetails();
}

async function fetchStatusDetails() {
    const target = document.getElementById('statusDetailContent');
    try {
        const res = await fetch('https://status.hedera.com/api/v2/summary.json');
        const data = await res.json();
        
        let html = `<div style="margin-bottom:20px; padding:10px; border-radius:6px; background:rgba(255,255,255,0.02); border-left:4px solid ${data.status.indicator === 'none' ? 'var(--success)' : 'var(--warning)'};">
            <div style="font-size:14px; font-weight:bold; color:#fff;">${data.status.description}</div>
            <div style="font-size:10px; color:#888; text-transform:uppercase; margin-top:4px;">Official Global Status</div>
        </div>`;

        // 1. Scheduled Maintenances
        if (data.scheduled_maintenances && data.scheduled_maintenances.length > 0) {
            html += `<div class="fiscal-header" style="color:var(--warning); border-bottom-color:var(--warning);">SCHEDULED MAINTENANCE</div>`;
            data.scheduled_maintenances.forEach(m => {
                html += `<div style="margin-bottom:15px; font-size:12px;">
                    <div style="color:#fff; font-weight:bold;">${m.name}</div>
                    <div style="color:#888; font-size:10px; margin-top:2px;">Scheduled: ${new Date(m.scheduled_for).toLocaleString()}</div>
                    <div style="color:#ccc; margin-top:5px; line-height:1.4;">${m.incident_updates[0].body}</div>
                </div>`;
            });
        }

        // 2. Active Incidents
        if (data.incidents && data.incidents.length > 0) {
            html += `<div class="fiscal-header" style="color:var(--danger); border-bottom-color:var(--danger);">ACTIVE INCIDENTS</div>`;
            data.incidents.forEach(i => {
                html += `<div style="margin-bottom:15px; font-size:12px;">
                    <div style="color:#fff; font-weight:bold;">${i.name}</div>
                    <div style="color:var(--danger); font-size:10px;">Status: ${i.status.toUpperCase()}</div>
                    <div style="color:#ccc; margin-top:5px; line-height:1.4;">${i.incident_updates[0].body}</div>
                </div>`;
            });
        }

        // 3. Core Components
        html += `<div class="fiscal-header">CORE COMPONENTS</div><table class="hub-table" style="font-size:11px;">`;
        data.components.forEach(c => {
            if (["Mainnet", "Mirror Node", "JSON-RPC Relay"].includes(c.name)) {
                const color = c.status === 'operational' ? 'var(--success)' : 'var(--warning)';
                html += `<tr><td style="color:#ccc;">${c.name}</td><td style="text-align:right; color:${color}; font-weight:bold; text-transform:uppercase; font-size:9px;">${c.status.replace('_',' ')}</td></tr>`;
            }
        });
        html += `</table>`;

        target.innerHTML = html;
    } catch (e) {
        target.innerHTML = `<p style="color:var(--danger); font-size:11px;">Unable to reach Hedera Status API.</p>`;
    }
}

    function init() {
window.juno.authSubscribe(async (user) => {
        if (user) {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            const doc = await window.juno.getDoc({ collection: "wallets", key: "my_data" });
            if (doc) state.wallets = doc.data.wallets;
            
            // Keep your original UI logic
            render(); 
            setInterval(render, 60000);
        } else {
            document.getElementById('welcomeScreen').style.display = 'flex';
        }
    });

    // Keep your original Theme/Privacy logic
    const savedPrivacy = localStorage.getItem('myhbar_privacy_preference');
    state.privacyMode = (savedPrivacy === 'true');
    const savedColor = localStorage.getItem('myhbar_theme');
    if (savedColor) document.documentElement.style.setProperty('--main-color', savedColor);
        updateNetworkStatus(); 
        setInterval(updateNetworkStatus, 5000); 
        startEpochTimer();
    }

    async function updateNetworkStatus() {
        const hDot = document.getElementById('mainnetHealth');
        try {
            const blocksRes = await fetch('https://mainnet-public.mirrornode.hedera.com/api/v1/blocks?limit=1');
            const blockData = await blocksRes.json();
            let isProducingBlocks = false;
            if (blockData.blocks && blockData.blocks[0]) {
                const b = blockData.blocks[0];
                const nowSec = Date.now() / 1000;
                const blockAge = nowSec - parseFloat(b.timestamp.to);
                if (blockAge < 12) isProducingBlocks = true;
                const duration = parseFloat(b.timestamp.to) - parseFloat(b.timestamp.from);
                const tps = Math.round(b.count / (duration || 1));
                setElementText('liveTps', tps.toLocaleString());
            }
            let apiStatus = 'unknown';
            try {
                const healthRes = await fetch('https://status.hedera.com/api/v2/status.json');
                const healthData = await healthRes.json();
                apiStatus = healthData.status.indicator;
            } catch(e) { }
            if (apiStatus === 'none' || isProducingBlocks) hDot.className = 'status-dot status-ok';
            else if (apiStatus === 'minor' || apiStatus === 'degraded') hDot.className = 'status-dot status-warning';
            else hDot.className = 'status-dot status-error';
        } catch (e) { hDot.className = 'status-dot status-error'; }
    }

    function closeWelcome() {
        const welcomeScreen = document.getElementById('welcomeScreen');
        if(welcomeScreen) welcomeScreen.style.display = 'none';
        render(); setInterval(render, 60000);
    }

    async function saveWallets() {
  await window.juno.setDoc({
    collection: "wallets",
    doc: { key: "my_data", data: { wallets: state.wallets } }
  });
}
    
  function formatHubVal(num, key) {
    const isExpanded = state.hubExpandedKeys.has(key);
    return num.toLocaleString(undefined, {
        minimumFractionDigits: isExpanded ? 8 : 4,
        maximumFractionDigits: isExpanded ? 8 : 4
    });
}

// Function to handle the click/toggle inside the modal
function toggleHubDecimal(key) {
    if (state.hubExpandedKeys.has(key)) state.hubExpandedKeys.delete(key);
    else state.hubExpandedKeys.add(key);
    renderEarningsHub();
}

function toggleHelp() { 
    if (state.privacyMode) return; 
    const modal = document.getElementById('helpModal');
    const isOpen = modal.style.display === 'flex';
    
    if (!isOpen) {
        renderEarningsHub();
        modal.style.display = 'flex';
    } else {
        modal.style.display = 'none';
    }
}

function switchHubView(view) {
    state.hubView = view;
    // Highlight the sticky tab
    const tabs = document.querySelectorAll('#hubTabs .tab-btn');
    tabs.forEach(t => t.classList.remove('active'));
    if (view === 'income') tabs[0].classList.add('active');
    else tabs[1].classList.add('active');
    
    renderEarningsHub();
}

function toggleHubSection(id) {
    if (state.hubSectionsOpen.has(id)) {
        state.hubSectionsOpen.delete(id);
    } else {
        state.hubSectionsOpen.add(id);
    }
    renderEarningsHub();
}

function renderEarningsHub() {
    if (!state.lastResults) return;

    const target = document.getElementById('hubContentTarget');
    let html = "";

    if (state.hubView === 'income') {
        // 1. Calculate the "Current" finalized daily totals (Earnings from Yesterday)
        let totalTrueHbar = 0; let totalHbarx = 0; let nDailyYesterday = 0;
        state.lastResults.forEach((w, index) => {
            if(w.success) {
                totalTrueHbar += w.hbarBalance;
                totalHbarx += w.hbarxAmount;
                const walletState = state.wallets[index];
                nDailyYesterday += (walletState.yesterdayNativeTotal || 0);
            }
        });

        const nMonthly = nDailyYesterday * 30.42;
        const unstakeVal = totalHbarx * state.staderRate;
        const xDaily = totalHbarx * (state.yesterdayDiff || 0);
        const xMonthly = xDaily * 30.42;
        const combD = nDailyYesterday + xDaily;
        const combM = nMonthly + xMonthly;

        // --- THE TREND BASELINE FIX ---
        const ledger = state.accountingLedger;
        const finalizedDate = new Date();
        finalizedDate.setDate(finalizedDate.getDate() - 1);
        const dateKey = finalizedDate.toISOString().split('T')[0]; // This is "Yesterday"

        let comparisonEntry = null;
        if (ledger.length > 0) {
            // If the last entry in the ledger is ALREADY yesterday (meaning the snapshot was taken),
            // we must look at the entry BEFORE it to find the comparison baseline.
            if (ledger[ledger.length - 1].date === dateKey) {
                comparisonEntry = ledger.length > 1 ? ledger[ledger.length - 2] : null;
            } else {
                // Otherwise, the last entry in the ledger is still the baseline.
                comparisonEntry = ledger[ledger.length - 1];
            }
        }

        function getTrendIcon(current, pastRaw) {
            if (pastRaw == null || pastRaw === '') return "";
            const past = Number(pastRaw);
            if (Number.isNaN(past)) return "";
            const diff = current - past;
            if (diff > 0.00000001) return `<span class="variance-up" style="font-size:10px; margin-left:4px;">â–²</span>`;
            if (diff < -0.00000001) return `<span class="variance-down" style="font-size:10px; margin-left:4px;">â–¼</span>`;
            return `<span class="variance-neutral" style="font-size:10px; margin-left:4px;">â€¢</span>`;
        }

        // Apply comparisonEntry to all indicators
        const nBalTrend = comparisonEntry ? getTrendIcon(totalTrueHbar, comparisonEntry.trueHbar) : "";
        const xBalTrend = comparisonEntry ? getTrendIcon(totalHbarx, comparisonEntry.hbarxBalance) : "";
        const nTrend = comparisonEntry ? getTrendIcon(nDailyYesterday, comparisonEntry.native) : "";
        const xTrend = comparisonEntry ? getTrendIcon(xDaily, comparisonEntry.liquid) : "";
        const cTrend = comparisonEntry ? getTrendIcon(combD, comparisonEntry.total) : "";

        let combinedVarianceHtml = "";
        if (comparisonEntry) {
            const diff = combD - comparisonEntry.total;
            const vKey = 'daily-variance';
            const vSign = diff > 0.00000001 ? "+" : "";
            const vClass = diff > 0.00000001 ? "variance-up" : (diff < -0.00000001 ? "variance-down" : "variance-neutral");
            combinedVarianceHtml = `<span class="${vClass} variance-text" style="cursor:pointer" onclick="event.stopPropagation(); toggleExact('${vKey}')">(${vSign}${formatLedger(diff, vKey)})</span>`;
        }

        html += `
            <div class="help-section active">
                <div class="help-header" style="cursor:default; border-bottom:1px solid #333; font-size:11px;">HBAR NATIVE STAKING <span class="rate-chip">${(state.currentNativeRate * 100).toFixed(3)}%</span></div>
                <table class="hub-table">
                    <tr><td class="hub-label">True Wallet Balance</td><td class="hub-val" onclick="toggleHubDecimal('nTrue')">${formatHubVal(totalTrueHbar, 'nTrue')} â„ ${nBalTrend}</td></tr>
                    <tr><td class="hub-label">Daily Reward</td><td class="hub-val" onclick="toggleHubDecimal('nDay')">+${formatHubVal(nDailyYesterday, 'nDay')} â„ ${nTrend}</td></tr>
                    <tr><td class="hub-label">Estimated Monthly</td><td class="hub-val" onclick="toggleHubDecimal('nMon')">+${formatHubVal(nMonthly, 'nMon')} â„</td></tr>
                </table>
            </div>
            <div class="help-section active" style="margin-top:15px;">
                <div class="help-header" style="cursor:default; border-bottom:1px solid #333; font-size:11px;">HBARX LIQUID <span class="rate-chip">+${(state.yesterdayDiff || 0).toFixed(8)} Î”</span></div>
                <table class="hub-table">
                    <tr><td class="hub-label">Balance</td><td class="hub-val" onclick="toggleHubDecimal('xBal')">${formatHubVal(totalHbarx, 'xBal')} Ä¦x ${xBalTrend}</td></tr>
                    <tr><td class="hub-label">Unstake Value</td><td class="hub-val" onclick="toggleHubDecimal('xUn')">${formatHubVal(unstakeVal, 'xUn')} â„</td></tr>
                    <tr><td class="hub-label">Daily Growth</td><td class="hub-val" onclick="toggleHubDecimal('xDay')">+${formatHubVal(xDaily, 'xDay')} â„ ${xTrend}</td></tr>
                    <tr><td class="hub-label">Estimated Monthly</td><td class="hub-val" onclick="toggleHubDecimal('xMon')">+${formatHubVal(xMonthly, 'xMon')} â„</td></tr>
                </table>
            </div>
            <div class="grand-total-box">
                <div class="combined-label">Combined Daily Total</div>
                <div class="combined-val" onclick="toggleHubDecimal('combD')">+${formatHubVal(combD, 'combD')} â„ ${cTrend} ${combinedVarianceHtml}</div>
                <div class="combined-label" style="margin-top:10px;">Combined Monthly Total</div>
                <div class="combined-val" onclick="toggleHubDecimal('combM')">+${formatHubVal(combM, 'combM')} â„</div>
            </div>
        `;
    }
     else {
        // --- SUMMARY TAB ---
        let totalTrueHbar = 0; let totalTrueUsd = 0;
        let totalHbarx = 0; let totalHbarxUsd = 0;
        let totalPending = 0; let totalPendingUsd = 0;
        let totalWalletWithPending = 0; 
        let totalAccruedNative = 0; let totalPrevNative = 0;
        let totalAccruedHbarx = 0; let totalPrevHbarx = 0;
        let totalUnstakeValue = 0;

        let trueRows = "";
        let xRows = "";
        let walletTotalRows = "";
        let unstakeRows = "";

        state.lastResults.forEach((w, index) => {
            if(!w.success) return;
            const ws = state.wallets[index];
            const price = state.prices.HBAR;
            
            // Collect True HBAR rows
            if (w.hbarBalance > 0) {
                totalTrueHbar += w.hbarBalance;
                totalTrueUsd += (w.hbarBalance * price);
                trueRows += `
                    <tr>
                        <td style="color:var(--main-color); font-weight:bold; padding-top:10px;">${ws.nickname}</td>
                        <td style="text-align:right; padding-top:10px;">$${formatUSD(w.hbarBalance * price)}</td>
                    </tr>
                    <tr><td colspan="4" style="font-family:monospace; font-size:12px; border-bottom:1px solid #222; color:#ccc; cursor:pointer;" onclick="toggleHubDecimal('tb${index}')">${formatHubVal(w.hbarBalance, 'tb'+index)} â„</td></tr>
                `;
            }

            // Collect True HBARX rows
            if (w.hbarxAmount > 0) {
                const xUsd = w.hbarxAmount * state.staderRate * price;
                totalHbarx += w.hbarxAmount;
                totalHbarxUsd += xUsd;
                xRows += `
                    <tr>
                        <td style="color:var(--main-color); font-weight:bold; padding-top:10px;">${ws.nickname}</td>
                        <td style="text-align:right; padding-top:10px;">$${formatUSD(xUsd)}</td>
                    </tr>
                    <tr><td colspan="4" style="font-family:monospace; font-size:12px; border-bottom:1px solid #222; color:#ccc; cursor:pointer;" onclick="toggleHubDecimal('xb${index}')">${formatHubVal(w.hbarxAmount, 'xb'+index)} Ä¦x</td></tr>
                `;
            }

            // Section 2 Logic
            const pend = w.stakingInfo ? w.stakingInfo.pending : 0;
            const accrued = ws.dailyNativeTotal || 0;
            const prev = ws.yesterdayNativeTotal || 0;
            totalPending += pend;
            totalPendingUsd += (pend * price);
            totalWalletWithPending += (w.hbarBalance + pend);
            totalAccruedNative += accrued;
            totalPrevNative += prev;

            walletTotalRows += `
                <tr>
                    <td style="color:var(--main-color); font-weight:bold; padding-top:10px;">${ws.nickname}</td>
                    <td style="text-align:right; color:var(--success); padding-top:10px; cursor:pointer;" onclick="toggleHubDecimal('acc${index}')">+${formatHubVal(accrued, 'acc'+index)} â„</td>
                    <td style="text-align:right; color:#666; padding-top:10px; cursor:pointer;" onclick="toggleHubDecimal('prev${index}')">+${formatHubVal(prev, 'prev'+index)} â„</td>
                </tr>
                <tr><td colspan="3" style="font-family:monospace; font-size:11px; border-bottom:1px solid #222; color:#ccc; cursor:pointer;" onclick="toggleHubDecimal('wp${index}')">${formatHubVal(w.hbarBalance + pend, 'wp'+index)} â„ <span style="color:#666; font-size:9px;">(Pending ${formatHubVal(pend, 'p'+index)})</span></td></tr>
            `;

            if (w.hbarxAmount > 0) {
                const uVal = w.hbarxAmount * state.staderRate;
                const uAccrued = w.hbarxAmount * (state.staderRate - state.previousRate);
                const uPrev = w.hbarxAmount * (state.yesterdayDiff || 0);
                totalUnstakeValue += uVal;
                totalAccruedHbarx += uAccrued;
                totalPrevHbarx += uPrev;

                unstakeRows += `
                    <tr>
                        <td style="color:var(--main-color); font-weight:bold; padding-top:10px;">${ws.nickname}</td>
                        <td style="text-align:right; color:var(--success); padding-top:10px; cursor:pointer;" onclick="toggleHubDecimal('ua${index}')">+${formatHubVal(uAccrued, 'ua'+index)} â„</td>
                        <td style="text-align:right; color:#666; padding-top:10px; cursor:pointer;" onclick="toggleHubDecimal('up${index}')">+${formatHubVal(uPrev, 'up'+index)} â„</td>
                    </tr>
                    <tr><td colspan="3" style="font-family:monospace; font-size:11px; border-bottom:1px solid #222; color:#ccc; cursor:pointer;" onclick="toggleHubDecimal('uv${index}')">${formatHubVal(uVal, 'uv'+index)} â„</td></tr>
                `;
            }
        });

        const isSec1Open = state.hubSectionsOpen.has('sec-true');
        const isSec2Open = state.hubSectionsOpen.has('sec-wallet');

        html += `
            <div style="text-align:right; font-size:12px; color:#888; margin-bottom:15px;">Wallet(s) + Pending Rew: <span style="color:#fff; font-weight:bold;">$${formatUSD(totalTrueUsd + totalHbarxUsd + totalPendingUsd)}</span></div>
            
            <!-- SECTION 1: TRUE WALLET BALANCES -->
            <div class="help-section ${isSec1Open ? 'active' : ''}" id="sec-true">
                <div class="help-header" onclick="toggleHubSection('sec-true')">TRUE WALLET BALANCES <span class="help-icon-state">${isSec1Open ? 'â–²' : 'â–¼'}</span></div>
                <div class="help-content">
                    
                    <div class="fiscal-header" style="font-size:10px; border-bottom: 1px solid var(--main-color); color:var(--main-color);">HBAR ASSETS</div>
                    <table class="hub-table" style="font-size:11px; margin-bottom:20px;">
                        <tr style="color:#555; font-size:9px; text-transform:uppercase;"><td></td><td style="text-align:right">USD Value</td></tr>
                        ${trueRows}
                        <tr style="font-weight:bold; background:rgba(255,255,255,0.02);">
                            <td style="padding:8px 0; cursor:pointer;" onclick="toggleHubDecimal('ttH')">Total ${formatHubVal(totalTrueHbar, 'ttH')} â„</td>
                            <td style="text-align:right;">$${formatUSD(totalTrueUsd)}</td>
                        </tr>
                    </table>

                    <div class="fiscal-header" style="font-size:10px; border-bottom: 1px solid var(--main-color); color:var(--main-color);">HBARX ASSETS</div>
                    <table class="hub-table" style="font-size:11px; margin-bottom:20px;">
                        ${xRows}
                        <tr style="font-weight:bold; background:rgba(255,255,255,0.02);">
                            <td style="padding:8px 0; cursor:pointer;" onclick="toggleHubDecimal('ttX')">Total ${formatHubVal(totalHbarx, 'ttX')} Ä¦x</td>
                            <td style="text-align:right;">$${formatUSD(totalHbarxUsd)}</td>
                        </tr>
                    </table>

                    <div class="grand-total-box" style="border-left: 4px solid var(--main-color); background:rgba(107, 91, 149, 0.05); margin-top:15px;">
                        <div class="combined-label" style="font-weight:bold; color:var(--main-color);">TRUE WALLET USD TOTAL</div>
                        <div class="combined-val" style="color:#fff; font-size:16px;">$${formatUSD(totalTrueUsd + totalHbarxUsd)}</div>
                        <div style="font-family:monospace; font-size:11px; color:#888; border-top: 1px solid #333; margin-top:5px; padding-top:5px;">
                           Sum of HBAR & HBARX Liquidity
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: WALLET TOTAL BALANCES -->
            <div class="help-section ${isSec2Open ? 'active' : ''}" style="margin-top:15px;" id="sec-wallet">
                <div class="help-header" onclick="toggleHubSection('sec-wallet')">WALLET TOTAL BALANCES <span class="help-icon-state">${isSec2Open ? 'â–²' : 'â–¼'}</span></div>
                <div class="help-content">
                    
                    <!-- RESTORED PENDING REWARDS LINE -->
                    <div style="text-align:right; font-size:10px; color:#666; margin-bottom:15px; margin-top:10px;">Pending Rewards Total: <span style="color:#ccc; cursor:pointer;" onclick="toggleHubDecimal('tp')">${formatHubVal(totalPending, 'tp')} â„</span> / <span style="color:#ccc;">$${formatUSD(totalPendingUsd)}</span></div>

                    <div class="fiscal-header" style="font-size:10px; border-bottom: 1px solid var(--main-color); color:var(--main-color);">NATIVE TOTALS (HBAR + PENDING)</div>
                    <table class="hub-table" style="font-size:11px; margin-bottom:20px;">
                        <tr style="color:#555; font-size:9px; text-transform:uppercase;"><td></td><td style="text-align:right">Accrued</td><td style="text-align:right">Prev Daily</td></tr>
                        ${walletTotalRows}
                        <tr style="font-weight:bold; background:rgba(255,255,255,0.02);">
                            <td style="padding:8px 0; cursor:pointer;" onclick="toggleHubDecimal('twwp')">Total ${formatHubVal(totalWalletWithPending, 'twwp')} â„</td>
                            <td style="text-align:right; color:var(--success); cursor:pointer;" onclick="toggleHubDecimal('tah')">+${formatHubVal(totalAccruedNative, 'tah')} â„</td>
                            <td style="text-align:right; color:#666; cursor:pointer;" onclick="toggleHubDecimal('tpd')">+${formatHubVal(totalPrevNative, 'tpd')} â„</td>
                        </tr>
                    </table>

                    <div class="fiscal-header" style="font-size:10px; border-bottom: 1px solid var(--main-color); color:var(--main-color);">HBARX UNSTAKE VALUE</div>
                    <table class="hub-table" style="font-size:11px; margin-bottom:20px;">
                        ${unstakeRows}
                        <tr style="font-weight:bold; background:rgba(255,255,255,0.02);">
                            <td style="padding:8px 0; cursor:pointer;" onclick="toggleHubDecimal('tuv')">Total ${formatHubVal(totalUnstakeValue, 'tuv')} â„</td>
                            <td style="text-align:right; color:var(--success); cursor:pointer;" onclick="toggleHubDecimal('thxd')">+${formatHubVal(totalAccruedHbarx, 'thxd')} â„</td>
                            <td style="text-align:right; color:#666; cursor:pointer;" onclick="toggleHubDecimal('thxd2')">+${formatHubVal(totalPrevHbarx, 'thxd2')} â„</td>
                        </tr>
                    </table>

                    <div class="grand-total-box" style="border-left: 4px solid var(--main-color); background:rgba(107, 91, 149, 0.05);">
                        <div class="combined-label" style="font-weight:bold; color:var(--main-color);">GRAND TOTAL (UNSTAKE + WALLET)</div>
                        <div class="combined-val" style="color:#fff; font-size:16px; margin: 5px 0; cursor:pointer;" onclick="toggleHubDecimal('gt')">${formatHubVal(totalUnstakeValue + totalWalletWithPending, 'gt')} â„</div>
                        <div style="display:flex; justify-content:space-between; font-family:monospace; font-size:12px; border-top: 1px solid #333; padding-top:5px;">
                            <span style="color:var(--success); font-weight:bold; cursor:pointer;" onclick="toggleHubDecimal('gta')">+${formatHubVal(totalAccruedNative + totalAccruedHbarx, 'gta')} â„</span>
                            <span style="color:#666; cursor:pointer;" onclick="toggleHubDecimal('gtp')">+${formatHubVal(totalPrevNative + totalPrevHbarx, 'gtp')} â„</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    target.innerHTML = html;
}

    function toggleHelpSection(btn) {
        const section = btn.parentElement;
        const icon = btn.querySelector('.help-icon-state');
        section.classList.toggle('active');
        icon.innerText = section.classList.contains('active') ? 'â–²' : 'â–¼';
    }

   function recordFiscalSnapshot() {
    const now = new Date();
    const yesterday = new Date(now);
    yesterday.setDate(yesterday.getDate() - 1);
    const dateKey = yesterday.toISOString().split('T')[0]; 
    
    let nativeRev = 0;
    state.lastResults?.forEach((w, i) => {
        nativeRev += (state.wallets[i].yesterdayNativeTotal || 0);
    });

    let totalHbarx = 0;
    state.lastResults?.forEach(w => { if(w.success) totalHbarx += w.hbarxAmount; });
    let liquidRev = totalHbarx * (state.yesterdayDiff || 0);

    if (nativeRev === 0 && liquidRev === 0) return;

    let ledger = state.accountingLedger;

    // --- YEAR-END ROLLOVER (The Fiscal Close) ---
    if (ledger.length >= 364 && !ledger.find(e => e.date === dateKey)) {
        const yNative = ledger.reduce((sum, d) => sum + d.native, 0);
        const yLiquid = ledger.reduce((sum, d) => sum + d.liquid, 0);
        const yTotal = yNative + yLiquid;
        
        state.fiscalArchives.push({
            yearNum: state.fiscalArchives.length + 1,
            native: yNative, liquid: yLiquid, total: yTotal,
            endDate: ledger[ledger.length-1].date
        });
        
        // Prune to 5 years history only
        if (state.fiscalArchives.length > 5) state.fiscalArchives.shift();
        
        localStorage.setItem('hbar_fiscal_archives', JSON.stringify(state.fiscalArchives));
        
        // Reset main ledger for Day 1 of the new year
        ledger = [];
        state.accountingLedger = ledger;
    }

    // --- RECORD DAILY ENTRY ---
    if (!ledger.find(e => e.date === dateKey)) {
        let totalTrueHbar = 0;
        let totalHbarx = 0;
        state.lastResults?.forEach(w => { 
            if(w.success) {
                totalTrueHbar += w.hbarBalance;
                totalHbarx += w.hbarxAmount;
            }
        });

        ledger.push({ 
            date: dateKey, 
            native: nativeRev, 
            liquid: liquidRev, 
            total: nativeRev + liquidRev,
            trueHbar: totalTrueHbar, // Save Native baseline
            hbarxBalance: totalHbarx // SURGICAL ADDITION: Save HBARX baseline
        });
   
    localStorage.setItem('hbar_fiscal_ledger', JSON.stringify(ledger));
 }
}

function toggleAccounting(view) {
    if (state.privacyMode) return;
    if (view) state.accountingView = view;
    const modal = document.getElementById('accountingModal');
    if (modal.style.display !== 'flex') {
        renderAccountingHub();
        modal.style.display = 'flex';
    } else if (!view) {
        modal.style.display = 'none';
    } else {
        renderAccountingHub();
    }
}

function renderAccountingHub() {
    const ledger = state.accountingLedger;
    const view = state.accountingView;
    const target = document.getElementById('accountingContent');

   const tabs = document.querySelectorAll('#accountingTabs .tab-btn');
    tabs.forEach(t => t.classList.remove('active'));
    if (view === 'weekly') tabs[0].classList.add('active');
    else if (view === 'periods') tabs[1].classList.add('active');
    else tabs[2].classList.add('active');
    
    if (ledger.length === 0) {
        target.innerHTML = `<p style="padding:20px; color:#666; font-size:12px;">Fiscal Ledger initialized. Waiting for first UTC day close...</p>`;
        return;
    }

    const totalDays = ledger.length;
    const currentPeriodNum = Math.ceil(totalDays / 28);
    const currentWeekNum = Math.ceil((totalDays % 28 || 28) / 7);

    let html = `<div class="fiscal-report">`;

    if (view === 'weekly') {
        const currentWeekEntries = ledger.slice(-7);
        const weeklyTotal = currentWeekEntries.reduce((sum, d) => sum + d.total, 0);
        const priorWeekEntries = ledger.slice(-14, -7);
        let weeklyVarHtml = "";
        if (priorWeekEntries.length > 0) {
            const priorTotal = priorWeekEntries.reduce((sum, d) => sum + d.total, 0);
            const diff = weeklyTotal - priorTotal;
            const vKey = 'w-var';
            const vClass = diff > 0.00000001 ? "variance-up" : (diff < -0.00000001 ? "variance-down" : "variance-neutral");
            weeklyVarHtml = `<span class="${vClass}" style="font-size:10px; cursor:pointer" onclick="event.stopPropagation(); toggleExact('${vKey}')">(${diff > 0 ? '+' : ''}${formatLedger(diff, vKey)})</span>`;
        }

        html += `
            <div class="fiscal-total-row" style="margin-bottom:15px; border-left-color:var(--main-color);">
                <div class="fiscal-row" style="border:none; padding:0;">
                    <span class="fiscal-label" style="color:#fff">WEEK ${currentWeekNum} <span style="font-size:8px; color:#666;">(PERIOD ${currentPeriodNum})</span></span>
                    <span class="fiscal-val" style="color:#fff; font-size:14px; cursor:pointer;" onclick="toggleExact('w-sum')">+${formatLedger(weeklyTotal, 'w-sum')} â„ ${weeklyVarHtml}</span>
                </div>
            </div>
            <div class="fiscal-header">Daily Audit Journal</div>`;
        
        const sortedDisplay = [...currentWeekEntries].reverse();
        sortedDisplay.forEach((day, idx) => {
            const key = `ledger-${day.date}`;
            const prevDay = sortedDisplay[idx + 1];
            let dayVarHtml = "";
            if (prevDay) {
                const diff = day.total - prevDay.total;
                const vClass = diff > 0.00000001 ? "variance-up" : (diff < -0.00000001 ? "variance-down" : "variance-neutral");
               dayVarHtml = `<span class="${vClass}" style="font-size:9px; margin-right:5px; font-family:monospace; cursor:pointer;" onclick="event.stopPropagation(); toggleExact('${key}-v')">${diff > 0 ? '+' : ''}${formatLedger(diff, key+'-v')}</span>`;
           }
            html += `<div class="fiscal-row"><span class="fiscal-label">${day.date}</span><span class="fiscal-val" style="cursor:pointer" onclick="toggleExact('${key}')">${dayVarHtml} +${formatLedger(day.total, key)} â„</span></div>`;
        });
    } 
    else if (view === 'periods') {
        html += `<div class="fiscal-header">28-Day Fiscal Performance Audit</div>`;
        let periodTotals = [];
        for (let i = ledger.length; i > 0; i -= 28) {
            const pData = ledger.slice(Math.max(0, i - 28), i);
            periodTotals.push({ total: pData.reduce((sum, d) => sum + d.total, 0), pNum: Math.ceil(i / 28), days: pData.length });
        }
        periodTotals.forEach((p, idx) => {
            const key = `ledger-p${p.pNum}`;
            const priorP = periodTotals[idx + 1];
            let pVarHtml = "";
            if (priorP) {
                const diff = p.total - priorP.total;
                const vClass = diff > 0.00000001 ? "variance-up" : (diff < -0.00000001 ? "variance-down" : "variance-neutral");
                pVarHtml = `<span class="${vClass}" style="font-size:10px; margin-right:8px; font-family:monospace;">${diff > 0 ? '+' : ''}${formatLedger(diff, key + '-v')}</span>`;
            }
            html += `<div class="fiscal-row"><span class="fiscal-label">Fiscal Period ${p.pNum} <span style="font-size:8px;">(${p.days} Days)</span></span><span class="fiscal-val" style="cursor:pointer" onclick="toggleExact('${key}')">${pVarHtml} +${formatLedger(p.total, key)} â„</span></div>`;
        });
    }
    else if (view === 'year') {
        const nRev = ledger.reduce((sum, d) => sum + d.native, 0);
        const lRev = ledger.reduce((sum, d) => sum + d.liquid, 0);
        const tRev = nRev + lRev;
        const qNum = currentPeriodNum <= 3 ? 1 : (currentPeriodNum <= 6 ? 2 : (currentPeriodNum <= 9 ? 3 : 4));
        
        let qHistoryHtml = "";
        const qBoundaries = [{ q: 1, end: 84 }, { q: 2, end: 168 }, { q: 3, end: 252 }, { q: 4, end: 364 }];
        qBoundaries.forEach((config, idx) => {
            const startIdx = idx === 0 ? 0 : qBoundaries[idx-1].end;
            if (totalDays > startIdx) {
                const qData = ledger.slice(startIdx, Math.min(totalDays, config.end));
                const qTotal = qData.reduce((sum, d) => sum + d.total, 0);
                const isCurrent = (totalDays <= config.end && totalDays > startIdx);
                const qKey = `q-hist-${config.q}`;
                qHistoryHtml += `<div class="fiscal-row" style="opacity: ${isCurrent ? '1' : '0.6'}; border-bottom: 1px solid #222;"><span class="fiscal-label">Q${config.q} Total <span style="font-size:8px;">(${isCurrent ? 'ACTIVE' : ''})</span></span><span class="fiscal-val" style="cursor:pointer" onclick="toggleExact('${qKey}')">+${formatLedger(qTotal, qKey)} â„</span></div>`;
            }
        });

        let yoyHtml = "";
        const lastYear = state.fiscalArchives[state.fiscalArchives.length - 1];
        if (lastYear) {
            const diff = (tRev / totalDays) - (lastYear.total / 364);
            const vKey = 'yoy-variance';
            const vClass = diff > 0.00000001 ? "variance-up" : (diff < -0.00000001 ? "variance-down" : "variance-neutral");
            yoyHtml = `<div class="fiscal-row" style="border-top:1px solid #333; margin-top:5px; padding-top:10px;"><span class="fiscal-label">YoY Daily Growth</span><span class="${vClass}" style="cursor:pointer; font-weight:bold;" onclick="toggleExact('${vKey}')">${diff > 0 ? 'â–²' : 'â–¼'} ${formatLedger(Math.abs(diff), vKey)} â„/Day</span></div>`;
        }

        html += `
            <div class="fiscal-header" style="display:flex; justify-content:space-between;"><span>ANNUAL ANALYSIS</span><span style="color:var(--main-color)">DAY ${totalDays} / 364</span></div>
            <div class="fiscal-row"><span class="fiscal-label">Current Status</span><span class="fiscal-val" style="color:var(--main-color)">YEAR ${state.fiscalArchives.length + 1} | QUARTER ${qNum}</span></div>
            <div class="fiscal-row"><span class="fiscal-label">Avg. Daily Revenue</span><span class="fiscal-val">+${formatLedger(tRev / totalDays, 'y-avg')} â„</span></div>
            ${yoyHtml}
            <div class="fiscal-header" style="margin-top:15px; font-size:9px; border-bottom: 1px solid #333;">Quarterly History</div>
            ${qHistoryHtml}
            <div class="fiscal-header" style="margin-top:15px; font-size:9px; border-bottom: 1px solid #333;">Revenue Segments</div>
            <div class="fiscal-row"><span class="fiscal-label">Native Staking</span><span class="fiscal-val" style="cursor:pointer" onclick="toggleExact('y-n')">+${formatLedger(nRev, 'y-n')} â„</span></div>
            <div class="fiscal-row"><span class="fiscal-label">Liquid Staking</span><span class="fiscal-val" style="cursor:pointer" onclick="toggleExact('y-l')">+${formatLedger(lRev, 'y-l')} â„</span></div>
            <div class="fiscal-total-row"><div class="fiscal-row" style="border:none; padding:0;"><span class="fiscal-label" style="color:var(--success)">NET FISCAL INCOME</span><span class="fiscal-val" style="color:var(--success); font-size:14px; cursor:pointer;" onclick="toggleExact('y-t')">+${formatLedger(tRev, 'y-t')} â„</span></div></div>`;
    }

    html += `</div>
        <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
            <button class="close-modal" style="border-color:#444; color:#666; font-size:9px; margin-top:0; width: 100%; margin-right: 0;" 
                onclick="if(confirm('Wipe ALL Fiscal History?')){localStorage.removeItem('hbar_fiscal_ledger'); localStorage.removeItem('hbar_fiscal_archives'); location.reload();}">RESET</button>
        </div>`;
    target.innerHTML = html;
}

// --- ACTIVITY HISTORY LOGIC ---

function getMonthStartTimestamp() {
    const d = new Date();
    const startOfMonth = new Date(d.getFullYear(), d.getMonth(), 1);
    return (startOfMonth.getTime() / 1000).toFixed(4);
}

function toggleHistorySection(id) {
    if (state.historySectionsOpen.has(id)) {
        state.historySectionsOpen.delete(id);
    } else {
        state.historySectionsOpen.add(id);
    }
    renderHistory();
}

async function toggleHistory() {
    if (state.privacyMode) return;
    const modal = document.getElementById('historyModal');
    if (modal.style.display !== 'flex') {
        modal.style.display = 'flex';
        renderHistory(true); // "true" means fetch from the internet
    } else {
        modal.style.display = 'none';
    }
}

function switchHistoryTab(tab) {
    state.historyView = tab;
    state.historyData = []; 
    const tabs = document.querySelectorAll('#historyTabs .tab-btn');
    
    // Remove 'active' class from all buttons
    tabs.forEach(t => t.classList.remove('active'));
    
    // Update the index based on the NEW HTML order:
    // [0] = Sessions, [1] = Staking, [2] = Transactions
    if (tab === 'sessions') tabs[0].classList.add('active');
    else if (tab === 'rewards') tabs[1].classList.add('active');
    else if (tab === 'activity') tabs[2].classList.add('active');

    // Sessions doesn't need to fetch from the Mirror Node (it uses data already in memory)
    renderHistory(tab !== 'sessions'); 
}
   
function toggleAddressBook() {
    const modal = document.getElementById('addressBookModal');
    modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    if (modal.style.display === 'flex') renderAddressBook();
}

function renderAddressBook() {
    const list = document.getElementById('addressBookList');
    if (state.addressBook.length === 0) {
        list.innerHTML = `<p style="color:#444; font-size:10px; text-align:center; padding:20px; font-family:monospace;">ADDRESS BOOK EMPTY</p>`;
        return;
    }
    let html = "";
    state.addressBook.forEach((c, i) => {
        html += `<div class="fiscal-row" style="padding:10px 0;">
            <span class="fiscal-label" style="color:var(--main-color); font-weight:bold;">${c.name.toUpperCase()}</span>
            <span class="fiscal-val" style="font-size:11px; font-family:monospace;">${c.id} <button class="btn-delete" onclick="removeContact(${i})">Ã—</button></span>
        </div>`;
    });
    list.innerHTML = html;
}

async function renderHistory(forceFetch = false) {
    const content = document.getElementById('historyContent');
    const timestamp = getMonthStartTimestamp();
    const DUST_THRESHOLD = 0.00001;
    const isRewardsMode = state.historyView === 'rewards';
    const isSessionsMode = state.historyView === 'sessions';

    if (isSessionsMode) {
        let trueRows = ""; let xRows = "";
        let tHbarRecent = 0; let tHbarPrev = 0;
        let tXRecent = 0; let tXPrev = 0;
        const getSessionColor = (val) => {
            if (Math.abs(val) < 0.00000001) return "#666";
            return val > 0 ? 'var(--success)' : 'var(--danger)';
        };
        const formatSess = (val, key) => {
            const isEx = state.expandedKeys.has(key);
            const f = val.toLocaleString(undefined, { minimumFractionDigits: isEx ? 8 : 4, maximumFractionDigits: isEx ? 8 : 4 });
            return (val > 0 ? "+" : "") + f;
        };
        (state.lastResults || []).forEach((w, index) => {
            if (!w.success) return;
            const ws = state.wallets[index];
            if (w.hbarBalance > 0) {
                tHbarRecent += (ws.lastChangeHbar || 0); tHbarPrev += (ws.prevChangeHbar || 0);
                trueRows += `<tr><td style="color:var(--main-color); font-weight:bold; padding-top:10px;">${ws.nickname}</td><td style="text-align:right; padding-top:10px; color:${getSessionColor(ws.lastChangeHbar || 0)}; cursor:pointer;" onclick="toggleExact('dL${index}')">${formatSess(ws.lastChangeHbar || 0, 'dL'+index)} â„</td><td style="text-align:right; padding-top:10px; padding-right:20px; color:${getSessionColor(ws.prevChangeHbar || 0)}; cursor:pointer;" onclick="toggleExact('dP${index}')">${formatSess(ws.prevChangeHbar || 0, 'dP'+index)} â„</td></tr>`;
            }
            if (w.hbarxAmount > 0) {
                tXRecent += (ws.lastChangeHbarx || 0); tXPrev += (ws.prevChangeHbarx || 0);
                xRows += `<tr><td style="color:var(--main-color); font-weight:bold; padding-top:10px;">${ws.nickname}</td><td style="text-align:right; padding-top:10px; color:${getSessionColor(ws.lastChangeHbarx || 0)}; cursor:pointer;" onclick="toggleExact('xL${index}')">${formatSess(ws.lastChangeHbarx || 0, 'xL'+index)} Ä¦x</td><td style="text-align:right; padding-top:10px; padding-right:20px; color:${getSessionColor(ws.prevChangeHbarx || 0)}; cursor:pointer;" onclick="toggleExact('xP${index}')">${formatSess(ws.prevChangeHbarx || 0, 'xP'+index)} Ä¦x</td></tr>`;
            }
        });
        content.innerHTML = `<div class="fiscal-header" style="color:var(--main-color); border-bottom: 1px solid var(--main-color); padding-bottom:5px; margin-bottom:5px;">TRUE WALLETS ACTIVITY</div><table class="hub-table" style="font-size:13px; margin-bottom:30px;"><tr style="font-size:11px; color:#555; text-transform:uppercase;"><th></th><th style="text-align:right">Recent +/-</th><th style="text-align:right; padding-right:20px;">Prev +/-</th></tr>${trueRows}<tr style="border-top:1px solid #333; font-weight:bold;"><td style="padding-top:10px;">Total:</td><td style="text-align:right; padding-top:10px; color:${getSessionColor(tHbarRecent)}; cursor:pointer;" onclick="toggleExact('tHR')">${formatSess(tHbarRecent, 'tHR')} â„</td><td style="text-align:right; padding-top:10px; padding-right:20px; color:${getSessionColor(tHbarPrev)}; cursor:pointer;" onclick="toggleExact('tHP')">${formatSess(tHbarPrev, 'tHP')} â„</td></tr></table><div class="fiscal-header" style="color:var(--main-color); border-bottom: 1px solid var(--main-color); padding-bottom:5px; margin-bottom:5px;">HBARX WALLETS ACTIVITY</div><table class="hub-table" style="font-size:13px;"><tr style="font-size:11px; color:#555; text-transform:uppercase;"><th></th><th style="text-align:right">Recent +/-</th><th style="text-align:right; padding-right:20px;">Prev +/-</th></tr>${xRows}<tr style="border-top:1px solid #333; font-weight:bold;"><td style="padding-top:10px;">Total:</td><td style="text-align:right; padding-top:10px; color:${getSessionColor(tXRecent)}; cursor:pointer;" onclick="toggleExact('tXR')">${formatSess(tXRecent, 'tXR')} Ä¦x</td><td style="text-align:right; padding-top:10px; padding-right:20px;   color:${getSessionColor(tXPrev)}; cursor:pointer;" onclick="toggleExact('tXP')">${formatSess(tXPrev, 'tXP')} Ä¦x</td></tr></table>`;
        return;
    }

    if (forceFetch || !state.historyData || state.historyData.length === 0) {
        content.innerHTML = `<p style="color:#666; font-size:11px; text-align:center; margin-top:30px; font-family:monospace;">QUERYING MIRROR NODE...</p>`;
        let fetchedData = [];
        for (const wallet of state.wallets) {
            try {
                let url = isRewardsMode ? `https://mainnet-public.mirrornode.hedera.com/api/v1/accounts/${wallet.id}/rewards?timestamp=gt:${timestamp}` : `https://mainnet-public.mirrornode.hedera.com/api/v1/transactions?account.id=${wallet.id}&timestamp=gt:${timestamp}&limit=100`;
                const res = await fetch(url);
                const data = await res.json();
                fetchedData.push({ wallet, data });
            } catch (e) { console.error(e); }
        }
        state.historyData = fetchedData;
    }

    const fmt = (num, key, def) => {
        const isEx = state.expandedKeys.has(key);
        return num.toLocaleString(undefined, { minimumFractionDigits: isEx ? 8 : def, maximumFractionDigits: isEx ? 8 : def });
    };

    let globalTotals = { hbar: { in: 0, out: 0 }, hbarx: { in: 0, out: 0 }, usdc: { in: 0, out: 0 }, fees: 0 };
    let allWalletsHtml = "";

    state.historyData.forEach(entry => {
        const wallet = entry.wallet;
        const data = entry.data;
        const wID = wallet.id.replace(/\./g, '');
        let wTotals = { hbar: { in: 0, out: 0 }, hbarx: { in: 0, out: 0 }, usdc: { in: 0, out: 0 }, fees: 0 };
        let txRowsHtml = "";

        if (isRewardsMode) {
            (data.rewards || []).forEach(r => {
                const amt = r.amount / 100000000;
                if (amt < DUST_THRESHOLD) return;
                wTotals.hbar.in += amt; globalTotals.hbar.in += amt;
                const rKey = `hist-rew-${r.timestamp}`;
                txRowsHtml += `<div class="fiscal-row"><span class="fiscal-label">${new Date(parseFloat(r.timestamp)*1000).toLocaleDateString()} â€¢ ${new Date(parseFloat(r.timestamp)*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span><span class="fiscal-val" style="color:var(--success); font-family:monospace; margin-right:12px; cursor:pointer;" onclick="toggleExact('${rKey}')">+${fmt(amt, rKey, 4)} â„</span></div>`;
            });
        } else {
            (data.transactions || []).forEach(tx => {
                const hbarChange = (tx.transfers.find(t => t.account === wallet.id)?.amount || 0) / 100000000;
                const rewardAmt = (tx.staking_reward_transfers?.find(r => r.account === wallet.id)?.amount || 0) / 100000000;
                const txFee = (tx.charged_tx_fee || 0) / 100000000;
                const netMove = hbarChange - rewardAmt;

                const hasReward = rewardAmt > DUST_THRESHOLD;
                const isSigSpend = Math.abs(netMove) > DUST_THRESHOLD;
                
                // Identify the true sender by checking the transaction ID's payer
                const isPayer = tx.transaction_id.startsWith(wallet.id + "-");

                const otherPartyId = (tx.transfers || []).filter(t => t.account !== wallet.id).sort((a, b) => Math.abs(b.amount) - Math.abs(a.amount))[0]?.account;
                const internalWallet = state.wallets.find(w => w.id !== wallet.id && (tx.transfers || []).some(t => t.account === w.id));
                const isInternal = !!internalWallet;
                const contact = state.addressBook.find(c => c.id === otherPartyId);

                wTotals.fees += txFee; globalTotals.fees += txFee;

                if (!isInternal) {
                    if (netMove > DUST_THRESHOLD) { wTotals.hbar.in += netMove; globalTotals.hbar.in += netMove; }
                    if (netMove < -DUST_THRESHOLD) { 
                        const pureSent = Math.abs(netMove) - txFee;
                        if (pureSent > 0.00000001) { wTotals.hbar.out += pureSent; globalTotals.hbar.out += pureSent; }
                    }
                }

                let typeLabel = "";
                if (isInternal) {
                    const myName = wallet.nickname.toUpperCase(); 
                    const otherName = internalWallet.nickname.toUpperCase();
                    // Direction fixed: based on who paid the fee, not the net balance change
                    typeLabel = isPayer ? `${myName} âž” ${otherName}` : `${otherName} âž” ${myName}`;
                    if (hasReward) typeLabel += "+REW"; 
                } else if (hasReward) {
                    typeLabel = isSigSpend ? (isPayer ? "SENT+REW" : "RECEIVED+REW") : "REWARD";
                } else if (tx.name === "CONTRACTCALL") {
                    typeLabel = "SWAP";
                } else {
                    typeLabel = isPayer ? "SENT" : "RECEIVED";
                }

                let memo = "";
                try { memo = tx.memo_base64 ? atob(tx.memo_base64).trim() : ""; } catch(e) { memo = ""; }
                const friendlyName = (tx.name || "").replace(/CRYPTO|CONSENSUS|TOKEN|TOPIC/g, '').replace(/([A-Z])/g, ' $1').trim().toUpperCase();
                let subDetail = memo ? memo : friendlyName;
                if (contact) subDetail = memo ? `${contact.name.toUpperCase()} â€¢ ${memo}` : `${friendlyName} (${contact.name.toUpperCase()})`;

                let tokenDetails = ""; let hasSigToken = false;
                tx.token_transfers?.forEach(tt => {
                    if (tt.account === wallet.id && tt.amount !== 0) {
                        const isX = tt.token_id === "0.0.834116"; const isU = tt.token_id === "0.0.456858";
                        const amt = tt.amount / (isU ? 1000000 : 100000000);
                        if (Math.abs(amt) < DUST_THRESHOLD) return;
                        hasSigToken = true;
                        if (!isInternal) {
                            if (isX) { if(amt > 0) { wTotals.hbarx.in += amt; globalTotals.hbarx.in += amt; } else { wTotals.hbarx.out += Math.abs(amt); globalTotals.hbarx.out += Math.abs(amt); } }
                            if (isU) { if(amt > 0) { wTotals.usdc.in += amt; globalTotals.usdc.in += amt; } else { wTotals.usdc.out += Math.abs(amt); globalTotals.usdc.out += Math.abs(amt); } }
                        }
                        const tKey = `hist-tx-t-${tx.consensus_timestamp}-${tt.token_id}`;
                        tokenDetails += `<div style="color:${amt > 0 ? 'var(--success)' : 'var(--danger)'}; font-size:10px; font-family:monospace; cursor:pointer;" onclick="event.stopPropagation(); toggleExact('${tKey}')">${amt > 0 ? '+' : ''}${fmt(amt, tKey, 2)} ${isX ? 'Ä¦x' : (isU ? 'USDC' : 'TOK')}</div>`;
                    }
                });

                if (!isSigSpend && !hasReward && !hasSigToken) return;

                const hKey = `hist-tx-h-${tx.consensus_timestamp}`;
                let valueDisplay = "";
                if (isSigSpend) {
                    valueDisplay += `<span style="color:${netMove > 0 ? 'var(--success)' : 'var(--danger)'}; margin-right:12px; cursor:pointer;" onclick="event.stopPropagation(); toggleExact('${hKey}')">${netMove > 0 ? '+' : ''}${fmt(netMove, hKey, 2)} â„</span>`;
                }
                if (hasReward) {
                    valueDisplay += `<span style="color:var(--success); margin-right:12px; cursor:pointer;" onclick="event.stopPropagation(); toggleExact('${hKey}')">+${fmt(rewardAmt, hKey, 2)} â„</span>`;
                }

                txRowsHtml += `<div class="fiscal-row" style="padding: 14px 0;">
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-size:9px; color:#555;">${new Date(parseFloat(tx.consensus_timestamp)*1000).toLocaleDateString()} â€¢ ${new Date(parseFloat(tx.consensus_timestamp)*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        <span class="fiscal-label" style="font-size:10px; font-weight:bold; display:block;">${typeLabel}</span>
                        <span style="font-size:8px; color:#666; text-transform:uppercase; display:block; margin-top:4px; font-family:monospace;">${subDetail}</span>
                   <a href="https://hashscan.io/mainnet/transaction/${tx.consensus_timestamp}" target="_blank" style="font-size:8px; color:var(--main-color); text-decoration:none; margin-top:8px; width:fit-content; font-weight:bold; letter-spacing:0.5px;">VIEW ON HASHSCAN â†—</a>
                    </div>
                    <div style="text-align:right; font-family:monospace; font-size:12px;">
                        ${valueDisplay}
                        ${tokenDetails}
                    </div>
                </div>`;
            });
        }

        let walletSumsHtml = "";
        if (wTotals.hbar.in > 0 || wTotals.hbar.out > 0) walletSumsHtml += `<div style="display:flex; gap:10px; cursor:pointer;" onclick="event.stopPropagation(); toggleExact('w-h-${wID}')"><span style="color:#666">â„:</span><span style="color:var(--success)">+${fmt(wTotals.hbar.in, 'w-h-'+wID, 2)}</span>${!isRewardsMode ? `<span style="color:var(--danger)">-${fmt(wTotals.hbar.out, 'w-h-'+wID, 2)}</span>` : ''}</div>`;
        if (wTotals.fees > 0) walletSumsHtml += `<div style="display:flex; gap:10px; cursor:pointer;" onclick="event.stopPropagation(); toggleExact('w-f-${wID}')"><span style="color:#666">FEES:</span><span style="color:var(--danger)">-${fmt(wTotals.fees, 'w-f-'+wID, 4)}</span></div>`;

        const sectionId = `hist-sec-${wID}`;
        const isOpen = state.historySectionsOpen.has(sectionId);

        allWalletsHtml += `
            <div class="help-section ${isOpen ? 'active' : ''}" style="margin-top:20px;">
                <div class="help-header" onclick="toggleHistorySection('${sectionId}')">
                    <div style="display:flex; flex-direction:column;">
                        <span style="font-size:12px; font-weight:bold; color:var(--main-color)">${wallet.nickname} | <span style="opacity:0.6; font-size:10px; font-family:monospace;">${wallet.id}</span></span>
                        <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:5px; font-family:monospace; font-size:10px;">
                            ${walletSumsHtml || '<div style="color:#444">No volume</div>'}
                        </div>
                    </div>
                    <span class="help-icon-state" style="margin-right:20px;">${isOpen ? 'â–²' : 'â–¼'}</span>
                </div>
                <div class="help-content" style="border-top:1px solid #222; margin-top:5px;">
                    ${txRowsHtml || '<div style="font-size:10px; color:#444; padding:10px;">No matching activity.</div>'}
                </div>
            </div>`;
    });

    let grandRows = "";
    if (isRewardsMode) {
        grandRows += `<tr style="cursor:pointer;" onclick="toggleExact('g-h')"><td style="color:#fff;">HBAR Rewards</td><td colspan="2" style="text-align:right; color:var(--success);">+${fmt(globalTotals.hbar.in, 'g-h', 2)}</td></tr>`;
    } else {
        if (globalTotals.hbar.in > 0 || globalTotals.hbar.out > 0) grandRows += `<tr style="cursor:pointer;" onclick="toggleExact('g-h')"><td style="color:#fff;">HBAR</td><td style="text-align:right; color:var(--success);">+${fmt(globalTotals.hbar.in, 'g-h', 0)}</td><td style="text-align:right; color:var(--danger);">${globalTotals.hbar.out > 0 ? '-' : ''}${fmt(globalTotals.hbar.out, 'g-h', 0)}</td></tr>`;
        if (globalTotals.fees > 0) grandRows += `<tr style="cursor:pointer;" onclick="toggleExact('g-f')"><td style="color:#888; font-size:10px;">NETWORK FEES (HBAR)</td><td colspan="2" style="text-align:right; color:var(--danger);">-${fmt(globalTotals.fees, 'g-f', 4)}</td></tr>`;
    }

    content.innerHTML = `<div class="grand-total-box" style="margin-bottom:20px; border-left-color:var(--main-color); background: rgba(255,255,255,0.02); padding:10px;"><div style="font-size:9px; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Monthly Volume</div><table style="width:100%; font-family:monospace; font-size:11px;">${isRewardsMode ? '<tr style="color:#666;"><td>Asset</td><td colspan="2" style="text-align:right;">Total Received (+)</td></tr>' : '<tr style="color:#666;"><td>Asset</td><td style="text-align:right;">Received (+)</td><td style="text-align:right;">Sent (-)</td></tr>'}${grandRows || '<tr><td colspan="3" style="text-align:center; padding:5px; color:#444;">No volume recorded.</td></tr>'}</table></div>${allWalletsHtml}`;
}

function addContact() {
    const id = document.getElementById('contactId').value.trim();
    const name = document.getElementById('contactName').value.trim();
    if (!id.match(/^0\.0\.\d+$/) || !name) { alert("Invalid ID or Name"); return; }
    state.addressBook.push({ id, name });
    localStorage.setItem('myhbar_address_book', JSON.stringify(state.addressBook));
    document.getElementById('contactId').value = "";
    document.getElementById('contactName').value = "";
    renderAddressBook();
    if (document.getElementById('historyModal').style.display === 'flex') renderHistory();
}

function removeContact(index) {
    if(confirm("Delete contact?")) {
        state.addressBook.splice(index, 1);
        localStorage.setItem('myhbar_address_book', JSON.stringify(state.addressBook));
        renderAddressBook();
        if (document.getElementById('historyModal').style.display === 'flex') renderHistory();
    }
}

        function toggleAddWalletModal() {
        const modal = document.getElementById('addWalletModal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

   function toggleSpec() {
    const modal = document.getElementById('specModal');
    modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
}

    function togglePrivacy() {
        if (!state.privacyMode) {
            const skipWarning = localStorage.getItem('myhbar_skip_lock_warning');
            if (skipWarning === 'true') {
                confirmLock();
            } else {
                document.getElementById('lockAlert').style.display = 'flex';
            }
            return;
        }
        
        const guess = prompt("Password:"); 
        if (guess) {
            const cleanGuess = guess.trim().toLowerCase();
            const isMatch = state.wallets.some(w => w.nickname.trim().toLowerCase() === cleanGuess || w.id.trim() === cleanGuess);
            if (isMatch) {
                state.privacyMode = false; document.getElementById('eyeBtn').innerText = "ðŸ”“";
                localStorage.setItem('myhbar_privacy_preference', 'false'); render(true);
            } else alert("Incorrect Password. Access Denied.");
        }
    }

    function confirmLock() {
        const checkbox = document.getElementById('hideLockWarning');
        if (checkbox.checked) localStorage.setItem('myhbar_skip_lock_warning', 'true');
        
        state.privacyMode = true;
        document.getElementById('eyeBtn').innerText = "ðŸ”’";
        localStorage.setItem('myhbar_privacy_preference', 'true');
        document.getElementById('lockAlert').style.display = 'none';
        
        document.getElementById('helpModal').style.display = 'none';
        render(true);
    }

    function pv(text, isUsd = false) { if (!state.privacyMode) return text; return isUsd ? "$****" : "****"; }
    function pvId(id) {
        if (!state.privacyMode) return id;
        const parts = id.split('.');
        if(parts.length === 3) return `${parts[0]}.${parts[1]}.*****`;
        return "*****";
    }

    function addWallet() {
    const idInput = document.getElementById('newId');
    const nickInput = document.getElementById('newNick');
    if(!idInput) return;
    const id = idInput.value.trim();
    const nick = nickInput.value.trim() || "Wallet";
    if (!id.match(/^0\.0\.\d+$/)) { alert("Invalid ID. Format: 0.0.12345"); return; }
    if(state.wallets.some(w => w.id === id)) { alert("Wallet already added!"); return; }
    const now = new Date();
    const epochDay = Math.floor(now.getTime() / 86400000); 
    state.wallets.push({ 
        id, nickname: nick, addedEpochDay: epochDay, 
        lastHbarxBalance: 0, 
        lastPendingReward: 0, 
        dailyNativeTotal: 0, 
        yesterdayNativeTotal: 0, 
        nativeStartPending: 0, 
        nativeEpochDay: epochDay,
        lastNativeUpdateTime: null // SURGICAL ADDITION
    });
    saveWallets(); idInput.value = ""; nickInput.value = ""; 
    toggleAddWalletModal(); render();
}

    function removeWallet(index) {
        if(confirm("Remove this wallet?")) { state.wallets.splice(index, 1); saveWallets(); render(); }
    }

    function formatUSD(num) { return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function formatToken(num) { return num.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 }); }

   
function formatLedger(num, key) {
    const isExpanded = state.expandedKeys.has(key);
    return num.toLocaleString(undefined, { 
        minimumFractionDigits: isExpanded ? 8 : 4, 
        maximumFractionDigits: isExpanded ? 8 : 4 
    });
}

   function toggleExact(key) {
    if(state.privacyMode) return; 
   
    // 1. Toggle the key in the state
    if(state.expandedKeys.has(key)) state.expandedKeys.delete(key); 
    else state.expandedKeys.add(key);
    
    // 2. Refresh the main dashboard
    render(true); 
    
    // 3. Force refresh the open popups so the change shows immediately
    const helpModal = document.getElementById('helpModal');
    if (helpModal && helpModal.style.display === 'flex') {
        renderEarningsHub();
    }
    
    const accModal = document.getElementById('accountingModal');
    if (accModal && accModal.style.display === 'flex') {
        renderAccountingHub();
    }

  const histModal = document.getElementById('historyModal');
    if (histModal && histModal.style.display === 'flex') {
        renderHistory();
    }

}


    function toEvmAddress(id) { const p = id.split('.'); return "0x" + "0".repeat(40 - parseInt(p[2]).toString(16).length) + parseInt(p[2]).toString(16); }
    function decodeUint256(hex) { return Number(BigInt("0x" + hex.replace("0x",""))) / 100000000; }
    
    function setElementText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
    function setElementHTML(id, html) { const el = document.getElementById(id); if(el) el.innerHTML = html; }
    function setElementClass(id, cls) { const el = document.getElementById(id); if(el) el.className = cls; }

    async function fetchGlobalData() {
        try {
            const res = await fetch("https://mainnet-public.mirrornode.hedera.com/api/v1/contracts/call", {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ data: "0xe6aa216c", to: toEvmAddress("0.0.1412503"), estimate: false })
            });
            const json = await res.json();
            const rate = decodeUint256(json.result);
            if (rate > 1) {
                const now = new Date();
                const epochDay = Math.floor(now.getTime() / 86400000); 
                let history = { current: rate, previous: rate, epochId: epochDay, lastTime: now.getTime(), yesterdayDiff: 0 };
                let needsSave = false;
                const savedJson = localStorage.getItem('stader_rate_history');
                if (!savedJson) { history.epochId = epochDay; needsSave = true; } 
                else {
                    try {
                        const parsed = JSON.parse(savedJson);
                        if(parsed && parsed.current) {
                            history = parsed;
                            if(!history.previous) history.previous = history.current;
                            if(!history.lastTime) history.lastTime = now.getTime();
                            if (parsed.epochId !== epochDay) {
                                history.yesterdayDiff = history.current - history.previous;
                                history.previous = history.current; 
                                history.epochId = epochDay; history.current = rate; history.lastTime = now.getTime(); needsSave = true;
                            } else if (Math.abs(rate - history.current) > 0.0000000001) {
                                history.current = rate; history.lastTime = now.getTime(); needsSave = true;
                            }
                        }
                    } catch(e) { history = { current: rate, previous: rate, epochId: epochDay, lastTime: now.getTime(), yesterdayDiff: 0 }; needsSave = true; } 
                }
                if(needsSave) localStorage.setItem('stader_rate_history', JSON.stringify(history));
                state.staderRate = rate;
                state.previousRate = history.previous; 
                state.lastUpdateTime = history.lastTime;
                state.yesterdayDiff = history.yesterdayDiff || 0; 
                const dailyGrowth = (history.previous > 0) ? (history.yesterdayDiff / history.previous) : 0;
                const flooredRate = Math.floor(rate * 1000000) / 1000000;
                setElementText('staderGlobal', flooredRate.toFixed(6));
                setElementClass('netStatus', 'status-dot status-ok');
            }
        } catch (e) { setElementClass('netStatus', 'status-dot status-error'); }
        try {
            const res = await fetch('https://mainnet-public.mirrornode.hedera.com/api/v1/network/exchangerate');
            const data = await res.json();
            if (data && data.current_rate) {
                const current = data.current_rate;
                const price = (current.cent_equivalent / current.hbar_equivalent) / 100;
                state.prices.NETWORK_HBAR = price;
                state.prices.HBAR = price; 
            }
        } catch (e) {}
    }

    async function fetchWalletData(account) {
      try {
        const [balRes, tokRes, accRes] = await Promise.all([
            fetch(`https://mainnet.mirrornode.hedera.com/api/v1/balances?account.id=${account.id}`),
            fetch(`https://mainnet.mirrornode.hedera.com/api/v1/accounts/${account.id}/tokens?limit=50`),
            fetch(`https://mainnet.mirrornode.hedera.com/api/v1/accounts/${account.id}`)
        ]);
        const balData = await balRes.json();
        const tokData = await tokRes.json();
        const accData = await accRes.json();
        const hbarBal = (balData.balances?.[0]?.balance || 0) / 100000000;
        let totalUsd = hbarBal * state.prices.HBAR;
        let tokenBalances = [];
        let hbarxAmount = 0;
        if (tokData.tokens) {
          tokData.tokens.forEach(t => {
            if (t.token_id === "0.0.456858") { 
                const amount = t.balance / 1000000;
                totalUsd += amount;
                tokenBalances.push({ symbol: "USDC", amount, price: 1.00, value: amount });
            }
            if (t.token_id === "0.0.834116") { 
                const amount = t.balance / 100000000;
                hbarxAmount = amount;
                const officialValUsd = (amount * state.staderRate) * state.prices.HBAR;
                totalUsd += officialValUsd;
                tokenBalances.push({ symbol: "HBARX", amount, price: (state.staderRate * state.prices.HBAR), value: officialValUsd });
            }
          });
        }
        tokenBalances.sort((a, b) => (a.symbol === 'HBARX' ? -1 : 1));
        let stakingInfo = null;
        if (accData.staked_node_id !== null) {
            let rewardRateStr = "N/A";
            try {
                const nodeRes = await fetch(`https://mainnet.mirrornode.hedera.com/api/v1/network/nodes?node.id=${accData.staked_node_id}`);
                const nodeData = await nodeRes.json();
                if (nodeData.nodes?.[0]?.reward_rate_start) {
                    const dailyRate = nodeData.nodes[0].reward_rate_start / 100000000;
                    rewardRateStr = (dailyRate * 365 * 100).toFixed(3) + '%';
                }
            } catch(e) {}
            stakingInfo = { stakedTo: `${accData.staked_node_id}`, pending: (accData.pending_reward || 0) / 100000000, rewardRate: rewardRateStr };
        }
        return {
            ...account, hbarBalance: hbarBal, totalUsd, tokenBalances,
            hbarxAmount, hbarxInHbar: hbarxAmount * state.staderRate,
            stakingInfo, success: true
        };
      } catch (e) { return { ...account, success: false }; }
    }

    async function render(skipFetch = false) {
        if(state.isRefreshing && !skipFetch) return;
        const now = new Date();
        const currentEpochDay = Math.floor(now.getTime() / 86400000); 
        const list = document.getElementById('walletList');
        const btn = document.getElementById('refreshButton');
        if(state.wallets.length === 0) {
            list.innerHTML = `<div style="color:#666; font-size:13px; padding:20px;">No wallets added.</div>`;
            return;
        }

        let results = [];
        if(!skipFetch) {
            state.isRefreshing = true;

            /* BEGIN UPDATE: Random Color Rotation */
            if (!localStorage.getItem('myhbar_theme')) {
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                document.documentElement.style.setProperty('--main-color', randomColor);
            }
            /* END UPDATE */

            if (state.prices.HBAR > 0) {
                state.oldHbarPrice = state.prices.HBAR;
                state.oldHbarxUsdPrice = state.staderRate * state.prices.HBAR;
            }
            setElementClass('netStatus', 'status-dot status-loading');
            btn.textContent = "Loading Data..."; btn.disabled = true;
            await fetchGlobalData();
            await syncNetworkNodes();
            const promises = state.wallets.map(w => fetchWalletData(w));
            results = await Promise.all(promises);
            let highestFoundRate = 0;
results.forEach(w => {
    if (w.stakingInfo && w.stakingInfo.rewardRate && w.stakingInfo.rewardRate !== "N/A") {
        const numericRate = parseFloat(w.stakingInfo.rewardRate) / 100; // Converts "2.481%" to 0.02481
        if (numericRate > highestFoundRate) highestFoundRate = numericRate;
    }
});
if (highestFoundRate > 0) state.currentNativeRate = highestFoundRate;
            results.forEach((newWalletData, index) => {
                const oldWalletData = state.wallets[index];

                // SURGICAL ADDITION: Track HBAR balance changes
                if (typeof oldWalletData.lastHbarBalance !== 'undefined') {
                    const hbarDiff = newWalletData.hbarBalance - oldWalletData.lastHbarBalance;
                    if (Math.abs(hbarDiff) > 0.0000001) {
                        oldWalletData.prevChangeHbar = oldWalletData.lastChangeHbar || 0;
                        oldWalletData.lastChangeHbar = hbarDiff;
                    }
                }
                oldWalletData.lastHbarBalance = newWalletData.hbarBalance;

                // SURGICAL ADDITION: Track HBARX balance changes
                if (typeof oldWalletData.lastHbarxAmount !== 'undefined') {
                    const xDiff = newWalletData.hbarxAmount - oldWalletData.lastHbarxAmount;
                    if (Math.abs(xDiff) > 0.00000001) {
                        oldWalletData.prevChangeHbarx = oldWalletData.lastChangeHbarx || 0;
                        oldWalletData.lastChangeHbarx = xDiff;
                    }
                }
                oldWalletData.lastHbarxAmount = newWalletData.hbarxAmount;

                if (typeof oldWalletData.addedEpochDay === 'undefined') oldWalletData.addedEpochDay = currentEpochDay; 
                if (typeof oldWalletData.nativeEpochDay === 'undefined') oldWalletData.nativeEpochDay = currentEpochDay;
                if (typeof oldWalletData.dailyNativeTotal === 'undefined') oldWalletData.dailyNativeTotal = 0;
                
                if (newWalletData.stakingInfo) {
            const currentPending = newWalletData.stakingInfo.pending;
            const lastPending = oldWalletData.lastPendingReward || 0;

            // 1. Handle Epoch Turnover (Midnight UTC)
            if (oldWalletData.nativeEpochDay !== currentEpochDay) {
                oldWalletData.yesterdayNativeTotal = oldWalletData.dailyNativeTotal; 
                oldWalletData.nativeStartPending = currentPending; 
                oldWalletData.dailyNativeTotal = 0;
                oldWalletData.nativeEpochDay = currentEpochDay;
                oldWalletData.lastNativeUpdateTime = null; // Clear time for the new day
                
                // Clear session change trackers for the new day
                oldWalletData.prevChangeHbar = oldWalletData.lastChangeHbar || 0;
                oldWalletData.lastChangeHbar = 0;
                oldWalletData.prevChangeHbarx = oldWalletData.lastChangeHbarx || 0;
                oldWalletData.lastChangeHbarx = 0;
            }

            // 2. Updated @ Logic: Trigger whenever the reward amount changes
            if (Math.abs(currentPending - lastPending) > 0.00000001) {
                // Record the time the network updated your rewards
                oldWalletData.lastNativeUpdateTime = now.getTime();

                // 3. GREEN NUMBER PRESERVATION: 
                // If rewards DROPPED (you claimed), adjust the baseline to 'lock in' 
                // the green accrued number so it doesn't disappear.
                if (lastPending > currentPending) {
                    oldWalletData.nativeStartPending -= lastPending;
                }
            }

            // 4. Update Current Daily Accrual
            oldWalletData.dailyNativeTotal = currentPending - oldWalletData.nativeStartPending;
            oldWalletData.lastPendingReward = currentPending;
        }
                
                oldWalletData.lastHbarxBalance = newWalletData.hbarxAmount || 0;
            });

            // 4. SAVE & CLEANUP
            saveWallets(); 
            state.lastResults = results;
            state.isRefreshing = false;
            btn.textContent = "Refresh Now"; btn.disabled = false;
        } else results = state.lastResults || [];

        updatePriceDisplay();
        let totalUsd = 0; let totalHbar = 0; let totalHbarEquiv = 0; 
        let totalNativeAccrued = 0;
        let totalHbarxAccrued = 0;
        let grandDailySnapshot = 0; 
        let sortableItems = [];

        results.forEach((w, index) => {
            if(!w.success) {
                const errHtml = `<div class="wallet" style="color:#f55; padding:15px;">Error loading ${w.id} <button class="btn-delete" onclick="removeWallet(${index})">Ã—</button></div>`;
                sortableItems.push({ html: errHtml, usdValue: -1 }); return;
            }
            
            const walletState = state.wallets[index];
            const nativeAccruedForThisWallet = walletState.dailyNativeTotal || 0;
            const yesterdayNative = walletState.yesterdayNativeTotal || 0;
            const fullPending = w.stakingInfo ? w.stakingInfo.pending : 0;
            const isNewWallet = walletState.addedEpochDay === currentEpochDay;
            const isBalanceChanged = (Math.abs(w.hbarxAmount - (walletState.lastHbarxBalance || 0)) > 1.0); 

            const yesterdayHbarxYield = w.hbarxAmount * (state.yesterdayDiff || 0);
            grandDailySnapshot += (yesterdayNative + yesterdayHbarxYield);

            totalNativeAccrued += nativeAccruedForThisWallet;
            totalUsd += w.totalUsd + (fullPending * state.prices.HBAR); 
            totalHbar += w.hbarBalance + fullPending; 
            totalHbarEquiv += (w.hbarBalance + w.hbarxInHbar + fullPending);
            
            const hbarKey = `${index}-HBAR`;
            const isHbarExpanded = state.expandedKeys.has(hbarKey);
            const hbarVal = isHbarExpanded ? w.hbarBalance.toLocaleString('en-US', {minimumFractionDigits:8}) : pv(formatToken(w.hbarBalance));
            let tokenHtml = `<div class="token-row"><div><div class="token-name">HBAR</div><div class="token-price">$${state.prices.HBAR.toFixed(4)}</div></div><div class="token-amount"><div class="token-balance" ${isHbarExpanded ? 'data-expanded="true"' : ''} onclick="toggleExact('${hbarKey}')">${hbarVal}</div><div class="token-value">${pv('$' + formatUSD(w.hbarBalance * state.prices.HBAR), true)}</div></div></div>`;
            if(w.stakingInfo) {
                const nativeDaily = walletState.dailyNativeTotal || 0;
                let nativeGainText = `<span style="color:#666; font-style:italic; font-size:11px;">Pending Daily Reward...</span>`;
                if (nativeDaily > 0.00000001) {
                    nativeGainText = `<span style="color:var(--success)">+${nativeDaily.toLocaleString('en-US', { minimumFractionDigits: 8 })} â„</span>`;
                }
                
                // SURGICAL UPDATE: NATIVE STAKING NOW MIRRORS HBARX LABELS AND TIMESTAMPS
                let nativeTimeText = walletState.lastNativeUpdateTime ? `Updated @ ${new Date(walletState.lastNativeUpdateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : "";
                let yestNativeText = "";
                if (yesterdayNative > 0.00000001) {
                    const yestNativeKey = `${index}-yestNative`;
                    const yestNativeVal = state.expandedKeys.has(yestNativeKey) ? yesterdayNative.toLocaleString('en-US', { minimumFractionDigits: 8 }) : yesterdayNative.toLocaleString('en-US', { minimumFractionDigits: 4 });
                    yestNativeText = `<span style="cursor:pointer" onclick="toggleExact('${yestNativeKey}')">(Prev. Daily Total: +${yestNativeVal})</span>`;
                }

                tokenHtml += `<div class="sub-info">
                    <div class="info-row"><span class="info-label">Staked to Node</span> <span class="info-val"><span class="node-trigger" onclick="event.stopPropagation(); showNodeAudit(${w.stakingInfo.stakedTo})">${w.stakingInfo.stakedTo}</span></span></div>
                    <div class="info-row"><span class="info-label">Pending Reward</span> <span class="info-val">${pv(w.stakingInfo.pending.toFixed(8) + ' â„')}</span></div>
                    <div class="info-row"><span class="info-label">APY</span> <span class="info-val">${w.stakingInfo.rewardRate}</span></div>
                    <div class="info-row" style="margin-bottom:0;"><span class="info-label">Accrued Earnings</span><span class="info-val">${state.privacyMode ? '****' : nativeGainText}</span></div>
                    ${state.privacyMode ? '' : `<div class="info-row" style="margin-top:2px;"><span style="font-size:10px; color:#888;">${nativeTimeText}</span><span style="font-size:10px; color:#888;">${yestNativeText}</span></div>`}
                </div>`;
            }
            w.tokenBalances.forEach(t => {
                const tKey = `${index}-${t.symbol}`;
                const isTExpanded = state.expandedKeys.has(tKey);
                const tVal = isTExpanded ? t.amount.toLocaleString('en-US', {minimumFractionDigits:8}) : pv(formatToken(t.amount));
                tokenHtml += `<div class="token-row"><div><div class="token-name">${t.symbol}</div><div class="token-price">$${t.price.toFixed(4)}</div></div><div class="token-amount"><div class="token-balance" ${isTExpanded ? 'data-expanded="true"' : ''} onclick="toggleExact('${tKey}')">${tVal}</div><div class="token-value">${pv('$' + formatUSD(t.value), true)}</div></div></div>`;
                if (t.symbol === 'HBARX' && w.hbarxAmount > 0) {
                    const officialVal = w.hbarxInHbar; const unstakeKey = `${index}-unstake`;
                    let unstakeText = state.expandedKeys.has(unstakeKey) ? officialVal.toLocaleString('en-US', { minimumFractionDigits: 8 }) : (Math.floor(officialVal * 10000) / 10000).toLocaleString('en-US', { minimumFractionDigits: 4 });
                    const displayRate = Math.floor(state.staderRate * 1000000) / 1000000;
                    const gainAmount = t.amount * (state.staderRate - (state.previousRate || state.staderRate));
                    
                    if (!isNewWallet && !isBalanceChanged) { totalHbarxAccrued += gainAmount; }

                    let syncLabel = "Accrued Earnings";
                    let gainText = `<span style="color:#666; font-style:italic; font-size:11px;">Pending Daily Reward...</span>`;
                     if (isNewWallet || isBalanceChanged) {
                        const reason = isNewWallet ? 'New Wallet' : 'Balance Change';
                        gainText = `<span style="color:#CCC; font-style:italic; font-size:11px;">Baseline Reset: ${reason}</span>`; 
                    }
                    else if(gainAmount > 0.00000001) {
                        gainText = `<span style="color:var(--success)">+${gainAmount.toLocaleString('en-US', { minimumFractionDigits: 8 })} â„</span>`;
                    }
                    let timeText = state.lastUpdateTime ? `Updated @ ${new Date(state.lastUpdateTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}` : "";
                    let yestText = "";
                    if (!isNewWallet && !isBalanceChanged && state.yesterdayDiff > 0.00000001) {
                        const yVal = t.amount * state.yesterdayDiff;
                        yestText = `<span style="cursor:pointer" onclick="toggleExact('${index}-yest')">(Prev. Daily Total: +${state.expandedKeys.has(`${index}-yest`) ? yVal.toLocaleString('en-US', { minimumFractionDigits: 8 }) : yVal.toLocaleString('en-US', { minimumFractionDigits: 4 })})</span>`;
                    }
                    tokenHtml += `<div class="sub-info"><div class="info-row"><span class="info-label">Exchange Rate</span><span class="info-val">1 HBARX = ${displayRate.toFixed(6)} â„</span></div><div class="info-row"><span class="info-label">Unstake Value</span><span class="info-val"><span style="cursor:pointer" onclick="toggleExact('${unstakeKey}')">${pv(unstakeText + ' â„')}</span></span></div><div class="info-row" style="margin-bottom:0;"><span class="info-label">${syncLabel}</span><span class="info-val">${state.privacyMode ? '****' : gainText}</span></div>${(state.privacyMode ? '' : `<div class="info-row" style="margin-top:2px;"><span style="font-size:10px; color:#888;">${timeText}</span><span style="font-size:10px; color:#888;">${yestText}</span></div>`)}</div>`;
                }              
           });
            const isWalletOpen = state.openTabs.has(w.id);
            const walletHtml = `<div class="wallet" id="wallet-${index}"><div class="wallet-header" onclick="toggleDetails('${w.id}')"><div class="wallet-info"><div class="wallet-nickname">${state.privacyMode ? 'Locked' : w.nickname}</div><div class="wallet-id">${pvId(w.id)}</div></div><div class="wallet-usd">${pv('$' + formatUSD(w.totalUsd), true)}<button class="btn-delete" onclick="event.stopPropagation(); removeWallet(${index})">Ã—</button></div></div><div class="wallet-details ${isWalletOpen ? 'expanded' : ''}" id="details-${w.id}"><div class="wallet-details-content">${tokenHtml}</div></div></div>`;
            sortableItems.push({ html: walletHtml, usdValue: w.totalUsd });
        });
        sortableItems.sort((a, b) => a.usdValue - b.usdValue);
        let finalHtmlContent = "";
        sortableItems.forEach(item => finalHtmlContent += item.html);
        list.innerHTML = finalHtmlContent;
        setElementText('totalUsd', pv('$' + formatUSD(totalUsd), true));
        
        const displayMode = state.totalDisplayMode; 
        
        // 1. Prepare the HBAR Equivalent String (Precision Toggleable)
        const equivKey = 'total-equiv';
        const hbarEquivText = state.expandedKeys.has(equivKey) ? totalHbarEquiv.toLocaleString('en-US', { minimumFractionDigits: 8 }) : formatToken(totalHbarEquiv);
        
        // 2. Prepare the USD String
        const usdText = formatUSD(totalUsd);

        // 3. Prepare the Labels
        const earningsTotal = totalNativeAccrued + totalHbarxAccrued;
        const earningsText = state.expandedKeys.has('total-earnings') ? earningsTotal.toLocaleString('en-US', { minimumFractionDigits: 8 }) : (Math.floor(earningsTotal * 10000) / 10000).toLocaleString('en-US', { minimumFractionDigits: 4 });
        const dailySnapshotText = state.expandedKeys.has('total-daily-snapshot') ? grandDailySnapshot.toLocaleString('en-US', { minimumFractionDigits: 8 }) : (Math.floor(grandDailySnapshot * 10000) / 10000).toLocaleString('en-US', { minimumFractionDigits: 4 });

        // 4. Build the "Income Flow" leading down to the Total
        const summaryHtml = `
            <div style="margin-bottom: 8px;">
                <div style="color:var(--success); font-size:12px; font-weight:500;">
                    Total Accrued Earnings: +<span style="cursor:pointer" onclick="toggleExact('total-earnings')">${pv(earningsText)}</span> â„
                </div>
                <div style="color:#888; font-size:11px; margin-top: 2px;">
                    Prev. Daily Grand Total: <span style="cursor:pointer" onclick="toggleExact('total-daily-snapshot')">+${pv(dailySnapshotText)}</span> â„
                </div>
            </div>

            <div style="cursor:pointer; font-size:18px; font-weight:700; padding-top:4px;" onclick="toggleTotalDisplay()">
                ${displayMode === 'HBAR' ? 
                    `Total: <span onclick="event.stopPropagation(); toggleExact('${equivKey}')">${pv(hbarEquivText)}</span> â„` : 
                    `Total USD: <span style="color:#fff;">${pv('$' + usdText, true)}</span>`
                }
            </div>
        `;
        
        state.lastTotalHbar = hbarEquivText;
        state.lastTotalUsd = usdText;
        state.lastAccrued = earningsText;
        state.lastGrandDaily = dailySnapshotText;
        setElementHTML('totalHbar', summaryHtml);

        if (state.staderRate > 1) {
            let rateText = state.expandedKeys.has('global-rate') ? state.staderRate.toLocaleString('en-US', { minimumFractionDigits: 8 }) : (Math.floor(state.staderRate * 1000000) / 1000000).toFixed(6);
            setElementHTML('staderGlobal', `<span style="cursor:pointer" onclick="toggleExact('global-rate')">${rateText}</span>`);
        }
       const hubModal = document.getElementById('helpModal');
        if (hubModal && hubModal.style.display === 'flex') {
            renderEarningsHub();
        }

    recordFiscalSnapshot(); // Books the daily entry
        if (document.getElementById('accountingModal').style.display === 'flex') renderAccountingHub();
    }
    
   // TOGGLE AND FETCH NODE LIST
function toggleNodeListModal() {
    const modal = document.getElementById('nodeListModal');
    if (modal.style.display !== 'flex') {
        renderNodeTable(); // Just draws the table from memory
        modal.style.display = 'flex';
    } else {
        modal.style.display = 'none';
    }
}

// This function only handles the DRAWING of the table
function renderNodeTable() {
    const body = document.getElementById('nodeListBody');
    const badge = document.getElementById('nodeCountBadge');
    
    if (state.nodes.length === 0) {
        body.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:40px; color:#444;">No node data synced.</td></tr>';
        return;
    }

    badge.innerText = `${state.nodes.length} Nodes Online`;
    
    let html = '';
    state.nodes.forEach(n => {
        const rewardRate = n.reward_rate_start / 100000000;
        const apy = (rewardRate * 365 * 100).toFixed(3);
        
        let host = n.description || '';
        let location = 'Global';
        if (host.includes('|')) {
            const parts = host.split('|');
            host = parts[0].replace('Hosted by ', '').replace('Hosted for ', '').trim();
            location = (parts[1] || '').trim() || 'Global';
        }

        html += `
            <tr style="cursor:pointer" onclick="showNodeAudit(${n.node_id})">
                <td class="node-id-cell">${n.node_id}</td>
                <td class="node-desc-cell">
                    <span class="node-host-label">${host}</span>
                    <span class="node-acc-label">${n.node_account_id} â€¢ ${location}</span>
                </td>
                <td class="node-reward-cell">${apy}%</td>
            </tr>
        `;
    });
    body.innerHTML = html;
}

// This is the background fetcher - Now fixed to fetch ALL nodes
async function syncNetworkNodes() {
    try {
        const base = 'https://mainnet-public.mirrornode.hedera.com';
        let url = base + '/api/v1/network/nodes?limit=100&order=asc';
        let allNodes = [];
        let safetyCounter = 0; 

        // The pagination loop you had before
        while (url && safetyCounter < 10) {
            safetyCounter++;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            if (Array.isArray(data.nodes)) {
                allNodes = allNodes.concat(data.nodes);
            }

            const links = data.links || {};
            let next = links.next || null;

            if (!next) {
                url = null;
            } else {
                url = next.startsWith('http') ? next : base + next;
            }
        }

        // Filter and save to state
        state.nodes = allNodes.filter(n => n && n.node_id !== null);
        
        // Silently update the badge if the modal happens to be open
        const badge = document.getElementById('nodeCountBadge');
        if (badge) badge.innerText = `${state.nodes.length} Nodes Online`;
        
    } catch (e) { 
        console.error("Node Sync Failed", e); 
    }
}

// These helper functions were sitting outside in your version - fixed:
function handleAccountingSync() {
    recordFiscalSnapshot();
    if (document.getElementById('accountingModal').style.display === 'flex') {
        renderAccountingHub();
    }
}

 function cycleColor() { const currentColor = getComputedStyle(document.documentElement).getPropertyValue('--main-color').trim(); const savedColor = localStorage.getItem('myhbar_theme'); if (!savedColor) { localStorage.setItem('myhbar_theme', currentColor); alert("Theme Locked!"); } else { let index = colors.indexOf(currentColor); const newColor = colors[(index + 1) % colors.length]; document.documentElement.style.setProperty('--main-color', newColor); localStorage.setItem('myhbar_theme', newColor); } }
   
 function resetColor() { localStorage.removeItem('myhbar_theme'); const randomColor = colors[Math.floor(Math.random() * colors.length)]; document.documentElement.style.setProperty('--main-color', randomColor); alert("Color Randomizer Restored!"); }

function copyAddress() { navigator.clipboard.writeText("0.0.8889863"); const msg = document.getElementById('copyMsg'); msg.innerText = "Address Copied! Thank You! Ä¦"; msg.style.opacity = 1; setTimeout(() => { msg.style.opacity = 0; setTimeout(() => msg.innerText = "Address Copied!", 500); }, 2000); }


    init();
  </script>
</body>
</html>